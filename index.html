<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–œå¹¼é»å–®ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: sans-serif; background: #f8f9fa; margin: 0; padding-bottom: 80px; }
        .nav-bar { background: #00b900; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10; }
        .container { padding: 15px; }
        .product-card { background: white; border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .product-img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; margin-right: 15px; background: #eee; }
        .controls { margin-left: auto; display: flex; align-items: center; }
        .btn-qty { width: 30px; height: 30px; border: none; background: #00b900; color: white; border-radius: 5px; }
        .qty { margin: 0 10px; font-weight: bold; width: 20px; text-align: center; }
        .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 15px; }
        .btn-page { padding: 8px 15px; background: #666; color: white; border: none; border-radius: 5px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .btn-submit { background: #00b900; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-size: 16px; }
        .hidden { display: none; }
        .history-item { background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; border-left: 4px solid #00b900; }
    </style>
</head>
<body>

<div class="nav-bar" id="viewTitle">å•†å“åˆ—è¡¨</div>

<div class="container">
    <div id="shopView">
        <div id="productList">è¼‰å…¥ä¸­...</div>
        <div class="pagination" id="pageControls">
            <button class="btn-page" onclick="changePage(-1)">ä¸Šä¸€é </button>
            <span id="pageInfo">ç¬¬ 1 é </span>
            <button class="btn-page" onclick="changePage(1)">ä¸‹ä¸€é </button>
        </div>
    </div>

    <div id="historyView" class="hidden">
        <div id="historyList">å°šç„¡æ­·å²ç´€éŒ„</div>
        <center><button onclick="window.location.href='?'" style="margin-top:20px; padding:10px;">å›åˆ°å•†åº—</button></center>
    </div>
</div>

<div class="footer" id="cartFooter">
    <div>ç¸½è¨ˆ: $<span id="totalAmount">0</span></div>
    <button class="btn-submit" onclick="submitOrder()">ç¢ºèªçµå¸³</button>
</div>

<script>
    const LIFF_ID = '2009084382-z4lJ5Lc6'; // âš ï¸ è«‹æ›´æ›
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyKAN46V-_VD40pg29b6cma2EQusfpA4oTu7LJzMZnnIv_pdrPTZhCMM-R0Tuli2ABRHw/exec'; // âš ï¸ è«‹æ›´æ›
    
    let allProducts = [];
    let cart = {};
    let currentPage = 1;
    const pageSize = 6; 
    let currentCategory = new URLSearchParams(window.location.search).get('cat');
    let viewMode = new URLSearchParams(window.location.search).get('view');

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        if (viewMode === 'history') {
            showHistoryView();
        } else {
            fetchProducts();
        }
    }

    async function fetchProducts() {
        const res = await fetch(GAS_URL);
        const data = await res.json();
        // ç¯©é¸åˆ†é¡ (å¦‚æœæœ‰)
        allProducts = currentCategory ? data.filter(p => p.category === currentCategory) : data;
        renderShop();
    }

    function renderShop() {
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const displayList = allProducts.slice(start, end);

        const listDiv = document.getElementById('productList');
        listDiv.innerHTML = displayList.map(p => `
            <div class="product-card">
                <img class="product-img" src="${p.img || ''}">
                <div><strong>${p.name}</strong><br><small>$${p.price}</small></div>
                <div class="controls">
                    <button class="btn-qty" onclick="updateCart('${p.name}', ${p.price}, -1)">-</button>
                    <span class="qty">${cart[p.name] || 0}</span>
                    <button class="btn-qty" onclick="updateCart('${p.name}', ${p.price}, 1)">+</button>
                </div>
            </div>
        `).join('');

        document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage} é `;
    }

    function changePage(delta) {
        if (currentPage + delta < 1) return;
        if ((currentPage + delta - 1) * pageSize >= allProducts.length) return;
        currentPage += delta;
        renderShop();
        window.scrollTo(0,0);
    }

    function updateCart(name, price, delta) {
        cart[name] = (cart[name] || 0) + delta;
        if (cart[name] < 0) cart[name] = 0;
        calculateTotal();
        renderShop(); // é‡æ–°æ•´ç†é¡¯ç¤ºæ•¸é‡
    }

    function calculateTotal() {
        let total = 0;
        // é€™è£¡éœ€è¦æ ¹æ“š allProducts æŸ¥æ‰¾åƒ¹æ ¼ï¼Œç°¡æ˜“ç¤ºç¯„
        for(let name in cart) {
            let p = allProducts.find(x => x.name === name);
            if(p) total += p.price * cart[name];
        }
        document.getElementById('totalAmount').innerText = total;
    }

    async function submitOrder() {
        if (document.getElementById('totalAmount').innerText === "0") return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
        const profile = await liff.getProfile();
        const userId = profile.userId; // é€™æ˜¯ LINE å®˜æ–¹æä¾›çš„å”¯ä¸€ç²¾æº– ID
        let details = Object.entries(cart).filter(x => x[1] > 0).map(x => `${x[0]} x${x[1]}`).join(', ');
        
        await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                userId: userId, // å‚³é€ç²¾æº– ID
                userName: profile.displayName,
                details: details,
                totalPrice: document.getElementById('totalAmount').innerText
            })
        });

        await liff.sendMessages([{ type: 'text', text: `ğŸ“¦ è¨‚å–®å·²é€å‡ºï¼\næ˜ç´°ï¼š${details}\nç¸½è¨ˆï¼š$${document.getElementById('totalAmount').innerText}` }]);
        liff.closeWindow();
    }

    async function showHistoryView() {
        document.getElementById('viewTitle').innerText = "æ­·å²è¨‚å–®";
        document.getElementById('shopView').classList.add('hidden');
        document.getElementById('cartFooter').classList.add('hidden');
        document.getElementById('historyView').classList.remove('hidden');

        const profile = await liff.getProfile();
        const userId = profile.userId; // ç”¨é€™å€‹æŸ¥æœ€ç²¾æº–ï¼Œä¸æ€•åŒååŒå§“
        const res = await fetch(`${GAS_URL}?action=getHistory&userName=${encodeURIComponent(profile.displayName)}`);
        const history = await res.json();
        
        document.getElementById('historyList').innerHTML = history.map(h => `
            <div class="history-item">
                <strong>æ—¥æœŸï¼š${h.date}</strong><br>
                æ˜ç´°ï¼š${h.details}<br>
                é‡‘é¡ï¼š$${h.total}
            </div>
        `).join('');
    }

    init();
</script>
</body>
</html>
