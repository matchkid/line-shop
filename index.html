<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-color: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }

        /* é ‚éƒ¨å°è¦½ */
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: white; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .search-area { padding: 10px 15px; }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; box-sizing: border-box; background: #f9f9f9; }
        .nav-tabs { display: flex; justify-content: space-around; padding-bottom: 0; border-bottom: 1px solid #eee; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: white; font-size: 14px; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
        .nav-btn.active { color: var(--line-green); border-bottom: 3px solid var(--line-green); font-weight: bold; }

        .main-content { padding-top: 100px; padding-bottom: 100px; }

        /* å•†å“å¡ç‰‡èˆ‡æ¨£å¼ */
        .section-title { padding: 15px 15px 5px; font-weight: bold; font-size: 16px; display: block; }
        .feat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; }
        .feat-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .feat-item img { width: 100%; height: 120px; object-fit: cover; }
        .feat-info { padding: 8px; text-align: center; font-size: 13px; }
        .info-box { background: white; margin: 15px; padding: 15px; border-radius: 8px; border-left: 5px solid var(--line-green); font-size: 14px; line-height: 1.6; color: #555; }
        .cat-scroller { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; background: white; white-space: nowrap; border-bottom: 1px solid #f0f0f0; }
        .cat-pill { padding: 6px 14px; border-radius: 20px; background: #f0f0f0; font-size: 13px; color: #555; cursor: pointer; }
        .cat-pill.active { background: var(--line-green); color: white; }
        .p-card { display: flex; background: white; padding: 10px; border-radius: 8px; margin: 10px 15px; align-items: center; }
        .p-img { width: 70px; height: 70px; border-radius: 6px; object-fit: cover; margin-right: 12px; }
        .p-details { flex: 1; }
        .p-link { text-decoration: none; color: #333; font-weight: bold; border-bottom: 1px dashed #999; }
        .p-price { color: #e44d26; font-weight: bold; display: block; margin-top: 4px; }
        .qty-box { display: flex; align-items: center; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty-val { margin: 0 8px; font-weight: bold; min-width: 20px; text-align: center; }

        /* æ­·å²ç´€éŒ„å¡ç‰‡ */
        .history-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .hist-item-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 6px; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        .status-badge[data-status="å·²å‡ºè²¨"] { background: #d4edda; color: #155724; }
        .status-badge[data-status="è™•ç†ä¸­"] { background: #fff3cd; color: #856404; }

        /* å½ˆçª—èˆ‡è¼‰å…¥å‹•ç•« */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 15px; padding: 20px; box-sizing: border-box; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { width: 100%; background: var(--line-green); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-close { width: 100%; background: #f0f0f0; color: #666; border: none; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #333; color: white; padding: 12px 20px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; cursor: pointer; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #06C755; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText" style="color:#666; margin-top:10px;">åº—å°äºŒè¶•å·¥ä¸­...</p>
    </div>

    <div class="fixed-header">
        <div class="search-area">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹å•†å“..." oninput="doSearch()">
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-home" onclick="switchTab('home')">é¦–é </button>
            <button class="nav-btn" id="tab-cat" onclick="switchTab('cat')">å•†å“ç›®éŒ„</button>
            <button class="nav-btn" id="tab-hist" onclick="switchTab('hist')">æ­·å²ç´€éŒ„</button>
        </div>
    </div>

    <div class="main-content">
        <div id="view-home">
            <span class="section-title">ğŸ”¥ å–œå¹¼ç²¾é¸</span>
            <div class="feat-grid">
                <div class="feat-item" onclick="quickAdd('ç²¾é¸å•†å“A', 490)">
                    <img src="https://via.placeholder.com/200x150?text=Hot+Sale">
                    <div class="feat-info">ç²¾é¸å•†å“A<br><b style="color:red">$490</b></div>
                </div>
                <div class="feat-item" onclick="quickAdd('ç²¾é¸å•†å“B', 320)">
                    <img src="https://via.placeholder.com/200x150?text=New+Item">
                    <div class="feat-info">ç²¾é¸å•†å“B<br><b style="color:red">$320</b></div>
                </div>
            </div>
            <div class="info-box">
                <b>ğŸ“¢ è³¼ç‰©å…¬å‘Š</b><br>
                1. å…¨é¤¨æ»¿ $8000 å…é‹ã€‚<br>
                2. åŒ¯æ¬¾å¾Œè«‹å‘ŠçŸ¥å¸³è™Ÿå¾Œäº”ç¢¼ä»¥åˆ©æŸ¥æ ¸ã€‚
            </div>
        </div>

        <div id="view-cat" class="hidden">
            <div class="cat-scroller" id="catBar"></div>
            <div id="catList" style="margin-top:10px;"></div>
            <div class="pager">
                <button onclick="changePage(-1)">ä¸Šä¸€é </button>
                <span id="pageInfo">1/1</span>
                <button onclick="changePage(1)">ä¸‹ä¸€é </button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div id="histList" style="padding-top:10px;"></div>
        </div>
    </div>

    <div id="cartBar" class="cart-bar hidden" onclick="openCartModal()">
        <div>ğŸ›’ å·²é¸ <span id="barCount">0</span> ä»¶</div>
        <div style="font-weight:bold;">æŸ¥çœ‹æ˜ç´° ></div>
    </div>

    <div id="regModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center;">ğŸ‘‹ æ­¡è¿ï¼è«‹å¡«å¯«åŸºæœ¬è³‡æ–™</h3>
            <div class="input-group">
                <label>æ”¶ä»¶äººå§“å</label>
                <input type="text" id="regName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
            </div>
            <div class="input-group">
                <label>é€£çµ¡é›»è©±</label>
                <input type="tel" id="regPhone" placeholder="ä¾‹å¦‚ï¼š0912345678">
            </div>
            <div class="input-group">
                <label>æ”¶ä»¶åœ°å€</label>
                <input type="text" id="regAddr" placeholder="è«‹è¼¸å…¥è©³ç´°å¯„é€åœ°å€">
            </div>
            <button class="btn-submit" onclick="submitRegister()">é–‹å§‹è³¼ç‰©</button>
        </div>
    </div>

    <div id="cartModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top:0;">ğŸ“‹ è³¼ç‰©è»Šç¢ºèª</h3>
            <div id="modalItems"></div>
            <div id="modalShippingInfo" style="text-align:right; margin-top:10px; font-size:13px; color:#666;"></div>
            <div style="text-align:right; margin-top:5px; font-weight:bold; font-size:18px; color:#e44d26;">
                ç¸½è¨ˆ: $<span id="modalTotal">0</span>
            </div>
            <button class="btn-submit" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
            <button class="btn-close" onclick="closeCartModal()">ç¹¼çºŒè³¼ç‰©</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx37yoU-QIfUEPOtPfUYm2BY3rIgUxziKO0HMXtv9Q-no8h9X_nI46dkLkG-e3kQxkHXg/exec"; 
        const LIFF_ID = "2009084382-z4lJ5Lc6"; 

        let allProducts = [], displayList = [], cart = {};
        let currentPage = 1, pageSize = 10;
        let currentUser = null;

        // é¡¯ç¤º/éš±è—è¼‰å…¥ç•«é¢
        function toggleLoading(show, text = "åº—å°äºŒè¶•å·¥ä¸­...") {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            overlay.style.display = show ? 'flex' : 'none';
        }

        // --- åˆå§‹åŒ– ---
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUser = { id: profile.userId, name: profile.displayName };

                const localReg = localStorage.getItem('isRegistered_' + currentUser.id);
                const fetchUrl = localReg ? GAS_URL : `${GAS_URL}?action=init&userId=${currentUser.id}`;

                const res = await fetch(fetchUrl);
                const data = await res.json();

                if (localReg) {
                    allProducts = data;
                } else {
                    allProducts = data.products;
                    if (data.registered) {
                        localStorage.setItem('isRegistered_' + currentUser.id, 'true');
                    } else {
                        // æœªè¨»å†Šï¼Œé¡¯ç¤ºå½ˆçª—
                        document.getElementById('regModal').classList.remove('hidden');
                    }
                }

                displayList = allProducts;
                initCategories();
                renderProducts();
            } catch (e) {
                alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ");
                console.error(e);
            } finally {
                // ğŸ’¡ ç„¡è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½è¦é—œé–‰è¼‰å…¥åœˆåœˆ
                toggleLoading(false);
            }
        }

        // è¨»å†Šæäº¤
        async function submitRegister() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const addr = document.getElementById('regAddr').value;

            if (!name || !phone || !addr) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
            
            toggleLoading(true, "è³‡æ–™å„²å­˜ä¸­...");
            const payload = { action: 'register', userId: currentUser.id, userName: name, phone: phone, address: addr };
            
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.status === 'success') {
                    localStorage.setItem('isRegistered_' + currentUser.id, 'true');
                    document.getElementById('regModal').classList.add('hidden');
                    alert("è¨»å†ŠæˆåŠŸï¼æ­¡è¿è³¼ç‰©");
                }
            } catch (e) {
                alert("é€£ç·šå¤±æ•—");
            } finally {
                toggleLoading(false);
            }
        }

        // (å…¶é¤˜è³¼ç‰©é‚è¼¯ä¿æŒä¸è®Š...)
        function initCategories() {
            const rawCats = allProducts.map(p => p.category);
            let uniqueCats = new Set(["å…¨éƒ¨"]);
            rawCats.forEach(cStr => { if(cStr) cStr.split('/').forEach(c => uniqueCats.add(c.trim())); });
            const bar = document.getElementById('catBar');
            bar.innerHTML = Array.from(uniqueCats).map(c => `<div class="cat-pill" onclick="filterCat(this, '${c}')">${c}</div>`).join('');
            if(bar.firstElementChild) bar.firstElementChild.classList.add('active');
        }

        function filterCat(btn, cat) {
            document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            displayList = (cat === "å…¨éƒ¨") ? allProducts : allProducts.filter(p => p.category.includes(cat));
            currentPage = 1; renderProducts();
        }

        function renderProducts() {
            const list = document.getElementById('catList');
            const start = (currentPage - 1) * pageSize;
            const chunk = displayList.slice(start, start + pageSize);
            list.innerHTML = chunk.map(p => {
                const qty = cart[p.name] ? cart[p.name].qty : 0;
                return `
                <div class="p-card">
                    <img class="p-img" src="${p.img || 'https://via.placeholder.com/70'}">
                    <div class="p-details"><b>${p.name}</b><span class="p-price">$${p.price}</span></div>
                    <div class="qty-box">
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, -1)">-</div>
                        <span class="qty-val">${qty}</span>
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, 1)">+</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('pageInfo').innerText = `${currentPage} / ${Math.ceil(displayList.length/pageSize)||1}`;
        }

        function updateCart(name, price, d) {
            if(!cart[name]) cart[name] = { price, qty: 0 };
            cart[name].qty += d;
            if(cart[name].qty <= 0) delete cart[name];
            updateCartBar();
            renderProducts();
        }

        function updateCartBar() {
            let count = 0; for(let k in cart) count += cart[k].qty;
            const bar = document.getElementById('cartBar');
            if(count > 0) { bar.classList.remove('hidden'); document.getElementById('barCount').innerText = count; }
            else { bar.classList.add('hidden'); }
        }

        function openCartModal() {
            const box = document.getElementById('modalItems'); box.innerHTML = "";
            let subtotal = 0;
            for (let n in cart) {
                const itemTotal = cart[n].price * cart[n].qty; subtotal += itemTotal;
                box.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                    <div>${n} x${cart[n].qty}</div><div>$${itemTotal}</div>
                </div>`;
            }
            const shipping = (subtotal >= 8000 || subtotal === 0) ? 0 : 100;
            document.getElementById('modalShippingInfo').innerText = `å°è¨ˆ: $${subtotal} + é‹è²»: $${shipping}`;
            document.getElementById('modalTotal').innerText = subtotal + shipping;
            document.getElementById('cartModal').classList.remove('hidden');
        }

        function closeCartModal() { document.getElementById('cartModal').classList.add('hidden'); }

        async function submitOrder() {
            toggleLoading(true, "è¨‚å–®é€å‡ºä¸­...");
            const payload = { userId: currentUser.id, userName: currentUser.name, cartJson: JSON.stringify(cart) };
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const r = await res.json();
                if(r.status === 'success') {
                    alert(r.msg);
                    cart = {}; updateCartBar(); closeCartModal(); switchTab('hist');
                }
            } catch(e) { alert("ç¶²è·¯éŒ¯èª¤"); }
            finally { toggleLoading(false); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-home', 'view-cat', 'view-hist'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            if(tab === 'hist') loadHistory();
        }

        async function loadHistory() {
            const list = document.getElementById('histList');
            list.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';
            try {
                const res = await fetch(`${GAS_URL}?action=getHistory&userId=${currentUser.id}`);
                const data = await res.json();
                list.innerHTML = data.map(o => `
                    <div class="history-card">
                        <div class="history-header"><span>${o.date}</span><span>${o.status}</span></div>
                        ${o.items.map(i => `<div class="hist-item-row"><span>${i.name} x${i.qty}</span></div>`).join('')}
                        <div style="text-align:right; color:red; font-weight:bold; margin-top:5px;">ç¸½è¨ˆ: $${o.total}</div>
                    </div>
                `).join('') || '<p style="text-align:center;">æŸ¥ç„¡è³‡æ–™</p>';
            } catch(e) { list.innerHTML = 'è¼‰å…¥ç´€éŒ„å¤±æ•—'; }
        }

        init();
    </script>
</body>
</html>
        .p-price { color: #e44d26; font-weight: bold; display: block; margin-top: 4px; }
        .qty-box { display: flex; align-items: center; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty-val { margin: 0 8px; font-weight: bold; min-width: 20px; text-align: center; }

        /* æ­·å²ç´€éŒ„å¡ç‰‡ */
        .history-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .hist-item-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 6px; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        .status-badge[data-status="å·²å‡ºè²¨"] { background: #d4edda; color: #155724; }
        .status-badge[data-status="è™•ç†ä¸­"] { background: #fff3cd; color: #856404; }

        /* å½ˆçª—èˆ‡è¼‰å…¥å‹•ç•« */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 15px; padding: 20px; box-sizing: border-box; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { width: 100%; background: var(--line-green); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-close { width: 100%; background: #f0f0f0; color: #666; border: none; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #333; color: white; padding: 12px 20px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; cursor: pointer; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #06C755; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText" style="color:#666; margin-top:10px;">åº—å°äºŒè¶•å·¥ä¸­...</p>
    </div>

    <div class="fixed-header">
        <div class="search-area">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹å•†å“..." oninput="doSearch()">
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-home" onclick="switchTab('home')">é¦–é </button>
            <button class="nav-btn" id="tab-cat" onclick="switchTab('cat')">å•†å“ç›®éŒ„</button>
            <button class="nav-btn" id="tab-hist" onclick="switchTab('hist')">æ­·å²ç´€éŒ„</button>
        </div>
    </div>

    <div class="main-content">
        <div id="view-home">
            <span class="section-title">ğŸ”¥ å–œå¹¼ç²¾é¸</span>
            <div class="feat-grid">
                <div class="feat-item" onclick="quickAdd('ç²¾é¸å•†å“A', 490)">
                    <img src="https://via.placeholder.com/200x150?text=Hot+Sale">
                    <div class="feat-info">ç²¾é¸å•†å“A<br><b style="color:red">$490</b></div>
                </div>
                <div class="feat-item" onclick="quickAdd('ç²¾é¸å•†å“B', 320)">
                    <img src="https://via.placeholder.com/200x150?text=New+Item">
                    <div class="feat-info">ç²¾é¸å•†å“B<br><b style="color:red">$320</b></div>
                </div>
            </div>
            <div class="info-box">
                <b>ğŸ“¢ è³¼ç‰©å…¬å‘Š</b><br>
                1. å…¨é¤¨æ»¿ $8000 å…é‹ã€‚<br>
                2. åŒ¯æ¬¾å¾Œè«‹å‘ŠçŸ¥å¸³è™Ÿå¾Œäº”ç¢¼ä»¥åˆ©æŸ¥æ ¸ã€‚
            </div>
        </div>

        <div id="view-cat" class="hidden">
            <div class="cat-scroller" id="catBar"></div>
            <div id="catList" style="margin-top:10px;"></div>
            <div class="pager">
                <button onclick="changePage(-1)">ä¸Šä¸€é </button>
                <span id="pageInfo">1/1</span>
                <button onclick="changePage(1)">ä¸‹ä¸€é </button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div id="histList" style="padding-top:10px;"></div>
        </div>
    </div>

    <div id="cartBar" class="cart-bar hidden" onclick="openCartModal()">
        <div>ğŸ›’ å·²é¸ <span id="barCount">0</span> ä»¶</div>
        <div style="font-weight:bold;">æŸ¥çœ‹æ˜ç´° ></div>
    </div>

    <div id="regModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center;">ğŸ‘‹ æ­¡è¿ï¼è«‹å¡«å¯«åŸºæœ¬è³‡æ–™</h3>
            <div class="input-group">
                <label>æ”¶ä»¶äººå§“å</label>
                <input type="text" id="regName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
            </div>
            <div class="input-group">
                <label>é€£çµ¡é›»è©±</label>
                <input type="tel" id="regPhone" placeholder="ä¾‹å¦‚ï¼š0912345678">
            </div>
            <div class="input-group">
                <label>æ”¶ä»¶åœ°å€</label>
                <input type="text" id="regAddr" placeholder="è«‹è¼¸å…¥è©³ç´°å¯„é€åœ°å€">
            </div>
            <button class="btn-submit" onclick="submitRegister()">é–‹å§‹è³¼ç‰©</button>
        </div>
    </div>

    <div id="cartModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top:0;">ğŸ“‹ è³¼ç‰©è»Šç¢ºèª</h3>
            <div id="modalItems"></div>
            <div id="modalShippingInfo" style="text-align:right; margin-top:10px; font-size:13px; color:#666;"></div>
            <div style="text-align:right; margin-top:5px; font-weight:bold; font-size:18px; color:#e44d26;">
                ç¸½è¨ˆ: $<span id="modalTotal">0</span>
            </div>
            <button class="btn-submit" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
            <button class="btn-close" onclick="closeCartModal()">ç¹¼çºŒè³¼ç‰©</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx37yoU-QIfUEPOtPfUYm2BY3rIgUxziKO0HMXtv9Q-no8h9X_nI46dkLkG-e3kQxkHXg/exec"; 
        const LIFF_ID = "2009084382-z4lJ5Lc6"; 

        let allProducts = [], displayList = [], cart = {};
        let currentPage = 1, pageSize = 10;
        let currentUser = null;

        // é¡¯ç¤º/éš±è—è¼‰å…¥ç•«é¢
        function toggleLoading(show, text = "åº—å°äºŒè¶•å·¥ä¸­...") {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            overlay.style.display = show ? 'flex' : 'none';
        }

        // --- åˆå§‹åŒ– ---
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUser = { id: profile.userId, name: profile.displayName };

                const localReg = localStorage.getItem('isRegistered_' + currentUser.id);
                const fetchUrl = localReg ? GAS_URL : `${GAS_URL}?action=init&userId=${currentUser.id}`;

                const res = await fetch(fetchUrl);
                const data = await res.json();

                if (localReg) {
                    allProducts = data;
                } else {
                    allProducts = data.products;
                    if (data.registered) {
                        localStorage.setItem('isRegistered_' + currentUser.id, 'true');
                    } else {
                        // æœªè¨»å†Šï¼Œé¡¯ç¤ºå½ˆçª—
                        document.getElementById('regModal').classList.remove('hidden');
                    }
                }

                displayList = allProducts;
                initCategories();
                renderProducts();
            } catch (e) {
                alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ");
                console.error(e);
            } finally {
                // ğŸ’¡ ç„¡è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½è¦é—œé–‰è¼‰å…¥åœˆåœˆ
                toggleLoading(false);
            }
        }

        // è¨»å†Šæäº¤
        async function submitRegister() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const addr = document.getElementById('regAddr').value;

            if (!name || !phone || !addr) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
            
            toggleLoading(true, "è³‡æ–™å„²å­˜ä¸­...");
            const payload = { action: 'register', userId: currentUser.id, userName: name, phone: phone, address: addr };
            
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.status === 'success') {
                    localStorage.setItem('isRegistered_' + currentUser.id, 'true');
                    document.getElementById('regModal').classList.add('hidden');
                    alert("è¨»å†ŠæˆåŠŸï¼æ­¡è¿è³¼ç‰©");
                }
            } catch (e) {
                alert("é€£ç·šå¤±æ•—");
            } finally {
                toggleLoading(false);
            }
        }

        // (å…¶é¤˜è³¼ç‰©é‚è¼¯ä¿æŒä¸è®Š...)
        function initCategories() {
            const rawCats = allProducts.map(p => p.category);
            let uniqueCats = new Set(["å…¨éƒ¨"]);
            rawCats.forEach(cStr => { if(cStr) cStr.split('/').forEach(c => uniqueCats.add(c.trim())); });
            const bar = document.getElementById('catBar');
            bar.innerHTML = Array.from(uniqueCats).map(c => `<div class="cat-pill" onclick="filterCat(this, '${c}')">${c}</div>`).join('');
            if(bar.firstElementChild) bar.firstElementChild.classList.add('active');
        }

        function filterCat(btn, cat) {
            document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            displayList = (cat === "å…¨éƒ¨") ? allProducts : allProducts.filter(p => p.category.includes(cat));
            currentPage = 1; renderProducts();
        }

        function renderProducts() {
            const list = document.getElementById('catList');
            const start = (currentPage - 1) * pageSize;
            const chunk = displayList.slice(start, start + pageSize);
            list.innerHTML = chunk.map(p => {
                const qty = cart[p.name] ? cart[p.name].qty : 0;
                return `
                <div class="p-card">
                    <img class="p-img" src="${p.img || 'https://via.placeholder.com/70'}">
                    <div class="p-details"><b>${p.name}</b><span class="p-price">$${p.price}</span></div>
                    <div class="qty-box">
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, -1)">-</div>
                        <span class="qty-val">${qty}</span>
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, 1)">+</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('pageInfo').innerText = `${currentPage} / ${Math.ceil(displayList.length/pageSize)||1}`;
        }

        function updateCart(name, price, d) {
            if(!cart[name]) cart[name] = { price, qty: 0 };
            cart[name].qty += d;
            if(cart[name].qty <= 0) delete cart[name];
            updateCartBar();
            renderProducts();
        }

        function updateCartBar() {
            let count = 0; for(let k in cart) count += cart[k].qty;
            const bar = document.getElementById('cartBar');
            if(count > 0) { bar.classList.remove('hidden'); document.getElementById('barCount').innerText = count; }
            else { bar.classList.add('hidden'); }
        }

        function openCartModal() {
            const box = document.getElementById('modalItems'); box.innerHTML = "";
            let subtotal = 0;
            for (let n in cart) {
                const itemTotal = cart[n].price * cart[n].qty; subtotal += itemTotal;
                box.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                    <div>${n} x${cart[n].qty}</div><div>$${itemTotal}</div>
                </div>`;
            }
            const shipping = (subtotal >= 8000 || subtotal === 0) ? 0 : 100;
            document.getElementById('modalShippingInfo').innerText = `å°è¨ˆ: $${subtotal} + é‹è²»: $${shipping}`;
            document.getElementById('modalTotal').innerText = subtotal + shipping;
            document.getElementById('cartModal').classList.remove('hidden');
        }

        function closeCartModal() { document.getElementById('cartModal').classList.add('hidden'); }

        async function submitOrder() {
            toggleLoading(true, "è¨‚å–®é€å‡ºä¸­...");
            const payload = { userId: currentUser.id, userName: currentUser.name, cartJson: JSON.stringify(cart) };
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const r = await res.json();
                if(r.status === 'success') {
                    alert(r.msg);
                    cart = {}; updateCartBar(); closeCartModal(); switchTab('hist');
                }
            } catch(e) { alert("ç¶²è·¯éŒ¯èª¤"); }
            finally { toggleLoading(false); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-home', 'view-cat', 'view-hist'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            if(tab === 'hist') loadHistory();
        }

        async function loadHistory() {
            const list = document.getElementById('histList');
            list.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';
            try {
                const res = await fetch(`${GAS_URL}?action=getHistory&userId=${currentUser.id}`);
                const data = await res.json();
                list.innerHTML = data.map(o => `
                    <div class="history-card">
                        <div class="history-header"><span>${o.date}</span><span>${o.status}</span></div>
                        ${o.items.map(i => `<div class="hist-item-row"><span>${i.name} x${i.qty}</span></div>`).join('')}
                        <div style="text-align:right; color:red; font-weight:bold; margin-top:5px;">ç¸½è¨ˆ: $${o.total}</div>
                    </div>
                `).join('') || '<p style="text-align:center;">æŸ¥ç„¡è³‡æ–™</p>';
            } catch(e) { list.innerHTML = 'è¼‰å…¥ç´€éŒ„å¤±æ•—'; }
        }

        init();
    </script>
</body>
</html>

