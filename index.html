<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-color: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }

        /* 1. é ‚éƒ¨æœå°‹èˆ‡å°è¦½ (å›ºå®š) */
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: white; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .search-area { padding: 10px 15px; }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; box-sizing: border-box; background: #f9f9f9; }
        
        .nav-tabs { display: flex; justify-content: space-around; padding-bottom: 0; border-bottom: 1px solid #eee; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: white; font-size: 14px; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
        .nav-btn.active { color: var(--line-green); border-bottom: 3px solid var(--line-green); font-weight: bold; }

        /* å…§å®¹å®¹å™¨ */
        .main-content { padding-top: 100px; padding-bottom: 100px; }

        /* 2. é¦–é å€å¡Š */
        .section-title { padding: 15px 15px 5px; font-weight: bold; font-size: 16px; display: block; }
        .feat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; }
        .feat-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .feat-item img { width: 100%; height: 120px; object-fit: cover; }
        .feat-info { padding: 8px; text-align: center; font-size: 13px; }

        .info-box { background: white; margin: 15px; padding: 15px; border-radius: 8px; border-left: 5px solid var(--line-green); font-size: 14px; line-height: 1.6; color: #555; }

        /* 3. ç›®éŒ„å€å¡Š (å¤šé‡åˆ†é¡æŒ‰éˆ•) */
        .cat-scroller { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; background: white; white-space: nowrap; border-bottom: 1px solid #f0f0f0; }
        .cat-pill { padding: 6px 14px; border-radius: 20px; background: #f0f0f0; font-size: 13px; color: #555; cursor: pointer; }
        .cat-pill.active { background: var(--line-green); color: white; }

        /* 4. å•†å“åˆ—è¡¨èˆ‡é€£çµ */
        .product-list { padding: 0 10px; margin-top: 10px; }
        .p-card { display: flex; background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; align-items: center; }
        .p-img { width: 70px; height: 70px; border-radius: 6px; object-fit: cover; margin-right: 12px; }
        .p-details { flex: 1; }
        
        /* é€£çµæ¨£å¼ */
        .p-link { text-decoration: none; color: #333; font-weight: bold; display: inline-block; border-bottom: 1px dashed #999; }
        .p-link:hover { color: var(--line-green); border-bottom-color: var(--line-green); }
        .p-no-link { font-weight: bold; color: #333; }

        .p-price { color: #e44d26; font-weight: bold; margin-top: 4px; display: block; }
        
        .qty-box { display: flex; align-items: center; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; background: white; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty-val { margin: 0 8px; font-weight: bold; min-width: 20px; text-align: center; }

        /* 5. æ­·å²ç´€éŒ„ */
        .history-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .history-items { font-size: 13px; color: #666; margin-bottom: 8px; line-height: 1.4; }
        .history-total { text-align: right; font-weight: bold; color: #e44d26; border-top: 1px solid #eee; padding-top: 5px; }

        /* 6. è³¼ç‰©è»Šåº•éƒ¨æ¢èˆ‡å½ˆçª— */
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #333; color: white; padding: 12px 20px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer; }
        
        /* å½ˆçª— Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-height: 80vh; border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .cart-item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn-submit { width: 100%; background: var(--line-green); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 15px; }
        .btn-close { width: 100%; background: #f0f0f0; color: #666; border: none; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 10px; }

        /* åˆ†é  */
        .pager { text-align: center; padding: 15px; }
        .pager button { padding: 5px 15px; margin: 0 5px; background: white; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="fixed-header">
        <div class="search-area">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹å•†å“..." oninput="doSearch()">
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-home" onclick="switchTab('home')">é¦–é </button>
            <button class="nav-btn" id="tab-cat" onclick="switchTab('cat')">å•†å“ç›®éŒ„</button>
            <button class="nav-btn" id="tab-hist" onclick="switchTab('hist')">æ­·å²ç´€éŒ„</button>
        </div>
    </div>

    <div class="main-content">
        <div id="view-home">
            <span class="section-title">ğŸ”¥ åº—é•·ç²¾é¸</span>
            <div class="feat-grid">
                <div class="feat-item" onclick="quickAdd('ç²¾é¸è­·é«®çµ„', 490)">
                    <img src="https://via.placeholder.com/200x150?text=Hot+Sale">
                    <div class="feat-info">ç²¾é¸è­·é«®çµ„<br><b style="color:red">$490</b></div>
                </div>
                <div class="feat-item" onclick="quickAdd('ä¿æ¿•é¢è†œ', 320)">
                    <img src="https://via.placeholder.com/200x150?text=New+Item">
                    <div class="feat-info">ä¿æ¿•é¢è†œ<br><b style="color:red">$320</b></div>
                </div>
            </div>

            <div class="info-box">
                <b>ğŸ“¢ è³¼ç‰©å…¬å‘Š</b><br>
                æ­¡è¿å…‰è‡¨ï¼<br>
                1. é»æ“Šã€Œå•†å“ç›®éŒ„ã€æŸ¥çœ‹æ›´å¤šåˆ†é¡ã€‚<br>
                2. æ»¿ $8000 å…é‹è²»ã€‚<br>
                3. ä¸‹å–®å¾Œè«‹ç•™æ„ LINE é€šçŸ¥ã€‚
            </div>
        </div>

        <div id="view-cat" class="hidden">
            <div class="cat-scroller" id="catBar"></div>
            <div id="catList" class="product-list"></div>
            <div class="pager" id="pagerBox">
                <button onclick="changePage(-1)">ä¸Šä¸€é </button>
                <span id="pageInfo">1/1</span>
                <button onclick="changePage(1)">ä¸‹ä¸€é </button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div id="histList" style="padding-top:10px;"></div>
        </div>
    </div>

    <div id="cartBar" class="cart-bar hidden" onclick="openCartModal()">
        <div>ğŸ›’ å·²é¸ <span id="barCount">0</span> ä»¶</div>
        <div style="font-weight:bold;">æŸ¥çœ‹æ˜ç´° ></div>
    </div>

    <div id="cartModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ“‹ è³¼ç‰©è»Šç¢ºèª</h3>
            <div id="modalItems"></div>
            <div style="text-align:right; margin-top:15px; font-weight:bold; font-size:16px;">
                ç¸½è¨ˆ: $<span id="modalTotal">0</span>
            </div>
            <button class="btn-submit" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
            <button class="btn-close" onclick="closeCartModal()">ç¹¼çºŒè³¼ç‰©</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxwrvcw7_fNRawY-7DgKga2YoC0vMYZSd0fU-T1-QyyWBp0s4qKk9v0AX115zUowpqDyQ/exec"; // âš ï¸ è«‹å‹™å¿…æ›´æ›
        const LIFF_ID = "2009084382-z4lJ5Lc6"; // âš ï¸ è«‹å‹™å¿…æ›´æ›

        let allProducts = [], displayList = [], cart = {};
        let currentPage = 1, pageSize = 10;
        let currentUser = null;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            currentUser = { id: profile.userId, name: profile.displayName };

            // è®€å–å•†å“è³‡æ–™
            const res = await fetch(GAS_URL);
            allProducts = await res.json();
            displayList = allProducts;

            // åˆå§‹åŒ–åˆ†é¡èˆ‡è¨»å†Šæª¢æŸ¥
            initCategories();
            checkRegister();
        }

        async function checkRegister() {
            // éœé»˜æª¢æŸ¥è¨»å†Šï¼Œè‹¥æœªè¨»å†Šå¯åœ¨æ­¤è™•åŠ å…¥å½ˆçª—é‚è¼¯
            fetch(`${GAS_URL}?action=checkUser&userId=${currentUser.id}`);
        }

        // --- 1. åˆ†é¡é‚è¼¯ (æ”¯æ´å¤šé‡åˆ†é¡ A/B/C) ---
        function initCategories() {
            const rawCats = allProducts.map(p => p.category);
            let uniqueCats = new Set(["å…¨éƒ¨"]);
            
            // æ‹†è§£æ–œç·š
            rawCats.forEach(cStr => {
                if(cStr) cStr.split('/').forEach(c => uniqueCats.add(c.trim()));
            });

            const bar = document.getElementById('catBar');
            bar.innerHTML = Array.from(uniqueCats).map(c => 
                `<div class="cat-pill" onclick="filterCat(this, '${c}')">${c}</div>`
            ).join('');
            
            // é è¨­é¸ä¸­å…¨éƒ¨
            bar.firstElementChild.classList.add('active');
        }

        function filterCat(btn, cat) {
            // UI æ›´æ–°
            document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // ç¯©é¸é‚è¼¯
            if (cat === "å…¨éƒ¨") {
                displayList = allProducts;
            } else {
                // åªè¦å•†å“åˆ†é¡å­—ä¸²ä¸­åŒ…å«è©²åˆ†é¡é—œéµå­—å³å¯ (ä¾‹å¦‚ "è­·é«®" in "éŸ“åœ‹/è­·é«®")
                displayList = allProducts.filter(p => p.category.includes(cat));
            }
            currentPage = 1;
            renderProducts();
        }

        // --- 2. è¦–åœ–åˆ‡æ› ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-cat').classList.add('hidden');
            document.getElementById('view-hist').classList.add('hidden');

            if (tab === 'home') document.getElementById('view-home').classList.remove('hidden');
            if (tab === 'cat') {
                document.getElementById('view-cat').classList.remove('hidden');
                renderProducts();
            }
            if (tab === 'hist') {
                document.getElementById('view-hist').classList.remove('hidden');
                loadHistory();
            }
            window.scrollTo(0,0);
        }

        // --- 3. æ¸²æŸ“å•†å“ (åŒ…å«é€£çµé‚è¼¯) ---
        function renderProducts() {
            const list = document.getElementById('catList');
            const start = (currentPage - 1) * pageSize;
            const chunk = displayList.slice(start, start + pageSize);

            list.innerHTML = chunk.map(p => {
                const qty = cart[p.name] ? cart[p.name].qty : 0;
                // é€£çµåˆ¤æ–·
                const nameHtml = p.link 
                    ? `<a href="${p.link}" target="_blank" class="p-link">${p.name} ğŸ”—</a>` 
                    : `<span class="p-no-link">${p.name}</span>`;

                return `
                <div class="p-card">
                    <img class="p-img" src="${p.img || 'https://via.placeholder.com/70'}">
                    <div class="p-details">
                        ${nameHtml}
                        <span class="p-price">$${p.price}</span>
                    </div>
                    <div class="qty-box">
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, -1)">-</div>
                        <span class="qty-val">${qty}</span>
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, 1)">+</div>
                    </div>
                </div>`;
            }).join('');

            // åˆ†é æ›´æ–°
            const totalPage = Math.ceil(displayList.length / pageSize) || 1;
            document.getElementById('pageInfo').innerText = `${currentPage} / ${totalPage}`;
        }

        function changePage(d) {
            const max = Math.ceil(displayList.length / pageSize) || 1;
            currentPage = Math.max(1, Math.min(max, currentPage + d));
            renderProducts();
            window.scrollTo(0,0);
        }

        function doSearch() {
            const key = document.getElementById('searchInput').value.toLowerCase();
            if(key) {
                switchTab('cat'); // è‡ªå‹•è·³è½‰åˆ°ç›®éŒ„
                displayList = allProducts.filter(p => p.name.toLowerCase().includes(key));
            } else {
                displayList = allProducts;
            }
            currentPage = 1;
            renderProducts();
        }

        // --- 4. è³¼ç‰©è»Šèˆ‡å½ˆçª—é‚è¼¯ ---
        function updateCart(name, price, d) {
            if(!cart[name]) cart[name] = { price, qty: 0 };
            cart[name].qty += d;
            if(cart[name].qty <= 0) delete cart[name];
            updateCartBar();
            // å¦‚æœåœ¨ç›®éŒ„é ï¼Œå³æ™‚æ›´æ–°æ•¸å­—
            if(!document.getElementById('view-cat').classList.contains('hidden')) renderProducts();
        }

        function quickAdd(name, price) {
            updateCart(name, price, 1);
            alert(`å·²å°‡ ${name} åŠ å…¥è³¼ç‰©è»Š`);
        }

        function updateCartBar() {
            let count = 0;
            for(let k in cart) count += cart[k].qty;
            const bar = document.getElementById('cartBar');
            if(count > 0) {
                bar.classList.remove('hidden');
                document.getElementById('barCount').innerText = count;
            } else {
                bar.classList.add('hidden');
            }
        }

        function openCartModal() {
            const container = document.getElementById('modalItems');
            let html = "", total = 0;
            for (let name in cart) {
                const item = cart[name];
                const sub = item.price * item.qty;
                total += sub;
                html += `
                <div class="cart-item-row">
                    <span>${name} x${item.qty}</span>
                    <span>$${sub}</span>
                </div>`;
            }
            container.innerHTML = html;
            document.getElementById('modalTotal').innerText = total;
            document.getElementById('cartModal').classList.remove('hidden');
        }

        function closeCartModal() {
            document.getElementById('cartModal').classList.add('hidden');
        }

        async function submitOrder() {
            if(!confirm("ç¢ºå®šé€å‡ºè¨‚å–®å—ï¼Ÿ")) return;
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­...
            document.querySelector('.btn-submit').innerText = "é€å‡ºä¸­...";
            
            const payload = {
                userId: currentUser.id,
                userName: currentUser.name,
                cartJson: JSON.stringify(cart)
            };

            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            
            if(result.status === 'success') {
                await liff.sendMessages([{ type: 'text', text: result.msg }]);
                alert("è¨‚å–®å·²é€å‡ºï¼");
                cart = {}; // æ¸…ç©ºè³¼ç‰©è»Š
                updateCartBar();
                closeCartModal();
                switchTab('hist'); // è·³è½‰åˆ°æ­·å²ç´€éŒ„
            } else {
                alert("éŒ¯èª¤: " + result.message);
            }
            document.querySelector('.btn-submit').innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
        }

        // --- 5. æ­·å²ç´€éŒ„é‚è¼¯ ---
        async function loadHistory() {
            const list = document.getElementById('histList');
            list.innerHTML = '<div style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</div>';
            
            const res = await fetch(`${GAS_URL}?action=getHistory&userId=${currentUser.id}`);
            const data = await res.json();
            
            if(data.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ç›®å‰æ²’æœ‰è¨‚å–®ç´€éŒ„</div>';
                return;
            }

            list.innerHTML = data.map(order => `
                <div class="history-card">
                    <div class="history-header">
                        <span>${order.date}</span>
                        <span style="color:${order.status==='è™•ç†ä¸­'?'#e44d26':'green'}">${order.status}</span>
                    </div>
                    <div class="history-items">
                        ${order.items.map(i => `<div>â€¢ ${i}</div>`).join('')}
                    </div>
                    <div class="history-total">
                        ç¸½é‡‘é¡: $${order.total} (å«é‹è²»$${order.shipping})
                    </div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>
</html>
