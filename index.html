<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; font-size: 14px; color: #333; }
        
        /* è¨»å†Šé®ç½© */
        #regModal { position: fixed; inset: 0; background: white; z-index: 9999; display: none; padding: 40px 25px; overflow-y: auto; }
        .reg-input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }

        /* é ‚éƒ¨å°èˆª */
        .header { background: #fff; padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; height: 50px; box-sizing: border-box; }
        .nav-btn { color: var(--line-green); font-size: 14px; cursor: pointer; min-width: 60px; }

        /* åˆ†é¡æŒ‰éˆ• */
        .cat-grid { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 15px; }
        .cat-card { background: white; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); font-weight: bold; font-size: 16px; color: #444; transition: background 0.2s; }
        .cat-card:active { background: #f0f0f0; }
        .cat-card::after { content: "â¯"; color: var(--line-green); font-size: 12px; }

        /* è¨‚å–®ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: normal; }
        .status-è™•ç†ä¸­ { background: #fff3cd; color: #856404; }
        .status-å·²å‡ºè²¨ { background: #d1ecf1; color: #0c5460; }
        .status-å·²å®Œæˆ { background: #d4edda; color: #155724; }

        /* å•†å“ç›¸é—œ */
        .product-name-link { color: #333; text-decoration: none; display: inline-block; }
        .container { padding: 10px; padding-bottom: 120px; }
        .product-card { background: #fff; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .product-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 12px; }
        .info { flex: 1; }
        .info b { font-size: 13px; }
        .product-note { font-style: italic; color: #999; font-size: 11px; margin-left: 5px; }
        
        /* æ­·å²è¨‚å–®ç›´åˆ—é¡¯ç¤ºå„ªåŒ– */
        .history-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); border-left: 5px solid var(--line-green); }
        .history-item-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; align-items: center; }

        /* è³¼ç‰©è»Šåº•æ¬„ä¿®æ­£ */
        .linote-footer { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #333; color: #fff; border-radius: 30px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; transition: 0.3s; transform: translateY(150px); }
        .footer-show { transform: translateY(0); }

        /* å½ˆçª—èˆ‡è¤‡è£½æŒ‰éˆ• */
        #cartModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 2000; align-items: flex-end; }
        .modal-content { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85%; overflow-y: auto; box-sizing: border-box; }
        .copy-btn { background: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; margin-top: 5px; }
        .btn-green { background: var(--line-green); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; width: 100%; font-size: 15px; margin-top: 15px; }
        .hidden { display: none; }
        /* åˆ†é æ§åˆ¶é … */
        .pager { text-align: center; padding: 50px; font-size: 12px; color: #666; }
        .pager select { margin-left: 10px; padding: 2px 5px; border-radius: 4px; }
/* å…¬å‘Šå€å¡Šæ¨£å¼ */
        .announcement-box {
    background: #fff;
    margin: 15px;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-left: 5px solid var(--line-green);
}
.announcement-box h3 { margin: 0 0 8px 0; color: #333; font-size: 16px; }
.announcement-box p { margin: 0; color: #666; line-height: 1.5; }

/* æ¨è–¦å•†å“å¯ä»¥ç¨å¾®åŠ å¤§ä¸€é» */
#recommendList .product-card { border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="regModal">
    <h2 style="margin-top:0">ğŸ‘‹ æ‚¨å¥½ï¼</h2>
    <p style="color:#666">é¦–æ¬¡ä½¿ç”¨è«‹å…ˆç™»è¨˜è¯çµ¡è³‡è¨Šï¼š</p>
    <input type="text" id="regName" class="reg-input" placeholder="æ”¶ä»¶äººå§“å">
    <input type="tel" id="regPhone" class="reg-input" placeholder="è¯çµ¡é›»è©±">
    <input type="text" id="regAddress" class="reg-input" placeholder="æ”¶ä»¶åœ°å€">
    <button class="btn-green" onclick="registerUser()">é–‹å§‹è³¼ç‰©</button>
</div>

<div id="mainApp" class="hidden">
    <div class="header">
        <div id="backBtn" class="nav-btn" onclick="showHome()" style="visibility:hidden">ğŸ  é¦–é </div>
        <div id="title">å–œå¹¼ å¾®å•†åŸ</div>
    </div>

    <div id="homeView">
        <div class="announcement-box">
            <h3>ğŸ‰ æœ¬æœˆæ¨è–¦</h3>
            <p>æ­¡è¿å…‰è‡¨ï¼å–œå¹¼ç‚ºæ‚¨æŒ‘é¸è¿‘æœŸæœ€ç†±é–€å•†å“ï¼Œè«‹åƒè€ƒï¼</p>
        </div>

        <div style="padding: 10px 15px; font-weight: bold; font-size: 16px;">ğŸ”¥ ç†±é–€æ¨è–¦</div>
        
        <div class="container" id="recommendList"></div>
    </div>

    <div id="catalogView" class="hidden">
        <div id="categoryGrid" class="cat-grid"></div>
        <div id="productList" class="container"></div>
    </div>

    <div id="historyView" class="hidden" style="padding:15px;">
        <div id="historyList"></div>
    </div>
</div>

<div id="shopView" class="hidden">
        <div class="container" id="productList"></div>
        <div class="pager">
            <span id="pageText">ç¬¬ 1 é  / å…± 1 é </span>
            <select id="pageSelect" onchange="jumpPage(this.value)"></select>
        </div>
    </div>
    
<div id="historyView" class="hidden" style="padding:15px;">
        <div id="historyList">æ­£åœ¨è®€å–æ­·å²è¨‚å–®...</div>
    </div>
</div>

<div class="linote-footer" id="footerBar">
    <div style="font-size:12px;">å·²é¸ <span id="cartCount">0</span> ä»¶ï¼Œå…± <b>$<span id="cartTotal">0</span></b></div>
    <button onclick="openCart()" style="background:var(--line-green); color:#fff; border:none; padding:6px 16px; border-radius:15px; font-weight:bold; font-size:13px;">ç¢ºèªè³¼ç‰©è»Š</button>
</div>

<div id="cartModal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="text-align:center; margin-top:0;">ğŸ›’ è¨‚å–®æ˜ç´°ç¢ºèª</h3>
        <div id="cartDetails"></div>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <div style="background:#f9f9f9; padding:15px; border-radius:10px; font-size:13px;">
            <p style="margin:5px 0;">ğŸ¦ åŒ¯æ¬¾éŠ€è¡Œï¼š(396) è¡—å£æ”¯ä»˜</p>
            <p style="margin:5px 0;">ğŸ”¢ åŒ¯æ¬¾å¸³è™Ÿï¼š903241863</p>
            <button class="copy-btn" onclick="copyToClipboard('903241863')">ğŸ“‹ é»æˆ‘è¤‡è£½å¸³è™Ÿ</button>
        </div>
        <button class="btn-green" onclick="finalSubmit()">ç¢ºèªä¸¦é€å‡ºè¨‚å–®</button>
    </div>
</div>

<script>
    const LIFF_ID = '2009084382-z4lJ5Lc6'; // âš ï¸ è«‹ç¢ºèªä½ çš„æ­£ç¢º ID
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRBRYk4dXvXd98KhIRHYez3k-xzl44kRAgZOXtEZ6DmuASJESDD90cB2GqP35TopQzqg/exec'; // âš ï¸ è«‹æ›¿æ›ç‚ºæ­£ç¢ºç¶²å€
    let allData = [], filteredProducts = [], page = 1, size = 10;
    let cart = JSON.parse(localStorage.getItem('shopCart')) || {};

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();

            const checkRes = await fetch(`${GAS_URL}?action=checkUser&userId=${profile.userId}`);
            const userStatus = await checkRes.json();
            
            if (!userStatus.registered) {
                document.getElementById('regModal').style.display = 'block';
                return;
            }

            const res = await fetch(GAS_URL);
            allData = await res.json();

const urlParams = new URLSearchParams(window.location.search);
    const pageType = urlParams.get('page');

    if (pageType === 'history') {
        showHistory();
    } else if (pageType === 'catalog') {
        showCatalog(); // é¡¯ç¤ºå•†å“ç›®éŒ„
    } else {
        showHome(); // é è¨­é¡¯ç¤ºé¦–é  (æ–‡å­—å€å¡Š + æ¨è–¦)
            }
            document.getElementById('mainApp').classList.remove('hidden');
            updateFooter(); // åˆå§‹åŒ–å¾Œç«‹å³æ›´æ–°ä¸€æ¬¡è³¼ç‰©è»Šé¡¯ç¤º
        } catch (err) {
            alert("åˆå§‹åŒ–å¤±æ•—: " + err);
        }
    }

    // è¨»å†ŠåŠŸèƒ½
    async function registerUser() {
        const name = document.getElementById('regName').value;
        const phone = document.getElementById('regPhone').value;
        const address = document.getElementById('regAddress').value;
        if(!name || !phone || !address) return alert("è«‹å®Œæ•´å¡«å¯«");
        const profile = await liff.getProfile();
        const res = await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action:'register', userId:profile.userId, userName:name, phone:phone, address:address }) 
        });
        const result = await res.json();
        if(result.status === 'success') {
            document.getElementById('regModal').style.display = 'none';
            location.reload(); 
        }
    }
    function showHome() {
    document.getElementById('homeView').classList.remove('hidden');
    document.getElementById('catalogView').classList.add('hidden');
    document.getElementById('historyView').classList.add('hidden');
    document.getElementById('backBtn').style.visibility = 'hidden';
    document.getElementById('title').innerText = "å–œå¹¼ å¾®å•†åŸ";

    // ç¯©é¸æ¨è–¦å•†å“ (å‡è¨­ä½ åœ¨è©¦ç®—è¡¨ note æ¬„ä½å¯«äº† "æ¨è–¦")
    const recommends = allData.filter(p => p.note && p.note.includes("æ¨è–¦"));
    renderList(recommends, 'recommendList');
}
    // é¡¯ç¤ºåˆ†é¡é é¢
    function showCatalog() {
    document.getElementById('homeView').classList.add('hidden');
    document.getElementById('catalogView').classList.remove('hidden');
    document.getElementById('backBtn').style.visibility = 'visible';
    document.getElementById('title').innerText = "å•†å“ç›®éŒ„";
    showCategories(); // é¡¯ç¤ºåŸæœ¬çš„åˆ†é¡æŒ‰éˆ•
}

// çµ±ä¸€çš„æ¸²æŸ“å‡½å¼
function renderList(items, targetId) {
    const target = document.getElementById(targetId);
    target.innerHTML = items.map(p => `
        <div class="product-card">
            <img class="product-img" src="${p.img || ''}">
            <div class="info">
                <b>${p.name}</b><br>
                <span style="color:#e44d26; font-weight:bold;">$${p.price}</span>
            </div>
            </div>
    `).join('');
}

    // é¡¯ç¤ºå•†å“é é¢
    function showProducts(cat) {
        document.getElementById('categoryView').classList.add('hidden');
        document.getElementById('historyView').classList.add('hidden');
        document.getElementById('shopView').classList.remove('hidden');
        document.getElementById('backBtn').style.visibility = 'visible';
        document.getElementById('title').innerText = cat;
        
        filteredProducts = allData.filter(p => p.category && p.category.split('/').includes(cat));
        page = 1;
        render();
    }

    // ç¹ªè£½å•†å“åˆ—è¡¨
    function render() {
        const totalPages = Math.ceil(filteredProducts.length / size) || 1;
        const start = (page - 1) * size;
        const displayItems = filteredProducts.slice(start, start + size);
        
        document.getElementById('productList').innerHTML = displayItems.map(p => `
            <div class="product-card">
                <img class="product-img" src="${p.img || ''}">
                <div class="info">
                    <a href="${p.link || '#'}" target="_blank" class="product-name-link">
                        <b>${p.name}</b>

                    </a>
                    <i class="product-note">${p.note || ''}</i><br>
                    <span style="color:#e44d26; font-weight:bold;">$${p.price}</span>
                </div>
                <div style="display:flex; align-items:center; background:#f8f8f8; border-radius:20px; padding:2px;">
                    <button onclick="add('${p.name}',${p.price},-1)" style="width:28px; height:28px; border-radius:50%; border:none; background:#fff;">-</button>
                    <span style="width:30px; text-align:center; font-weight:bold;" id="q-${p.name}">${cart[p.name]?.qty || 0}</span>
                    <button onclick="add('${p.name}',${p.price},1)" style="width:28px; height:28px; border-radius:50%; border:none; background:var(--line-green); color:#fff;">+</button>
                </div>
            </div>
        `).join('');
         // åˆ†é  UI
        document.getElementById('pageText').innerText = `ç¬¬ ${page} é  / å…± ${totalPages} é `;
        let opt = '';
        for(let i=1; i<=totalPages; i++) opt += `<option value="${i}" ${i===page?'selected':''}>ç¬¬ ${i} é </option>`;
        document.getElementById('pageSelect').innerHTML = opt;
    }

    // æ­·å²ç´€éŒ„ - ä¿®æ”¹ç‚ºç›´åˆ—é¡¯ç¤º
    async function showHistory() {
        document.getElementById('categoryView').classList.add('hidden');
        document.getElementById('shopView').classList.add('hidden');
        document.getElementById('historyView').classList.remove('hidden');
        document.getElementById('backBtn').style.visibility = 'visible';
        document.getElementById('title').innerText = "æ­·å²è¨‚å–®ç´€éŒ„";
        document.getElementById('historyList').innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æ­£åœ¨è®€å–è¨‚å–®...</div>';
        
        try {
            const profile = await liff.getProfile();
            const res = await fetch(`${GAS_URL}?action=getHistory&userId=${profile.userId}`);
            const history = await res.json(); // âš ï¸ æ³¨æ„ï¼šé€™è£¡çš„ GAS å›å‚³éœ€å°æ‡‰ã€Œç›´åˆ—çµæ§‹ã€
            
            if (!history || history.length === 0) {
                document.getElementById('historyList').innerText = "å°šç„¡è¨‚å–®ç´€éŒ„ã€‚";
                return;
            }

            // æ­¤è™•å‡è¨­ GAS å·²è™•ç†ç‚ºåˆ†çµ„å¾Œçš„è¨‚å–®é™£åˆ—ï¼Œè‹¥ GAS å°šæœªæ”¹å¯«ï¼Œæš«ä»¥ç¾æœ‰æ¬„ä½æ¨¡æ“¬ç›´åˆ—
            document.getElementById('historyList').innerHTML = history.map(h => `
                <div class="history-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span class="history-date">ğŸ“… ${h.date}</span>
                        <span class="status-badge status-${h.status}">${h.status}</span>
                    </div>
                    <div style="background:#fcfcfc; padding:10px; border-radius:8px;">
                        ${h.details.split(',').map(item => `<div class="history-item-row"><span>${item.trim()}</span></div>`).join('')}
                    </div>
                    <div class="history-total">ç¸½è¨ˆ(å«é‹)ï¼š$${h.total}</div>
                </div>
            `).join('');
        } catch (e) {
            document.getElementById('historyList').innerText = "è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }

    // åŠ å…¥è³¼ç‰©è»Š
    function add(name, price, d) {
        if(!cart[name]) cart[name] = { qty: 0, price: price };
        cart[name].qty += d;
        if(cart[name].qty <= 0) delete cart[name];
        localStorage.setItem('shopCart', JSON.stringify(cart));
        const el = document.getElementById(`q-${name}`);
        if(el) el.innerText = cart[name]?.qty || 0;
        updateFooter();
    }

    // æ›´æ–°è³¼ç‰©è»Šåº•æ¬„
    function updateFooter() {
        let subtotal = 0, count = 0;
        for(let k in cart) { subtotal += cart[k].qty * cart[k].price; count += cart[k].qty; }
        
        // é¡¯ç¤ºæˆ–éš±è—è³¼ç‰©è»Š Bar
        const footer = document.getElementById('footerBar');
        if (count > 0) {
            footer.classList.add('footer-show');
        } else {
            footer.classList.remove('footer-show');
        }

        // é‹è²»é‚è¼¯ï¼šæ»¿ 8000 å…é‹ï¼Œå¦å‰‡ 100 å…ƒ
        let shipping = (subtotal >= 8000 || subtotal === 0) ? 0 : 100;
        document.getElementById('cartTotal').innerText = subtotal + shipping;
        document.getElementById('cartCount').innerText = count;
    }

    // æ‰“é–‹ç¢ºèªè¦–çª—
    function openCart() {
        let subtotal = 0;
        let h = '<div style="margin-bottom:15px;">';
        for(let k in cart) {
            let itemTotal = cart[k].qty * cart[k].price;
            subtotal += itemTotal;
            h += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0;">
                    <span>${k} x ${cart[k].qty}</span>
                    <span>$${itemTotal}</span>
                  </div>`;
        }
        let shipping = (subtotal >= 8000) ? 0 : 100;
        h += `</div>
              <div style="text-align:right; font-size:13px; color:#666;">å•†å“å°è¨ˆï¼š$${subtotal}</div>
              <div style="text-align:right; font-size:13px; color:#666;">é‹è²»ï¼š$${shipping}</div>
              <div style="text-align:right; font-weight:bold; color:#e44d26; font-size:18px; margin-top:5px;">æ‡‰ä»˜ç¸½é¡ï¼š$${subtotal + shipping}</div>`;
        
        document.getElementById('cartDetails').innerHTML = h;
        document.getElementById('cartModal').style.display = 'flex';
    }

    // è¤‡è£½å¸³è™ŸåŠŸèƒ½
    function copyToClipboard(text) {
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert("åŒ¯æ¬¾å¸³è™Ÿå·²è¤‡è£½ï¼\n(396) 903241863");
    }

    // é€å‡ºè¨‚å–®
    async function finalSubmit() {
        try {
            const profile = await liff.getProfile();
            // è¨ˆç®—ç¸½é‡‘é¡èˆ‡é‹è²» (ç‚ºäº†é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹)
        let subtotal = 0;
        for(let k in cart) { subtotal += cart[k].qty * cart[k].price; }
        let shipping = (subtotal >= 8000) ? 0 : 100;
        let finalTotal = subtotal + shipping;
        
        // æº–å‚™è¨‚å–®æ˜ç´°å­—ä¸² (çµ¦ LINE è¨Šæ¯ç”¨)
        const detailsStr = Object.entries(cart).map(([n,o]) => `${n} x${o.qty}`).join('\n');

        // ğŸš€ é—œéµä¿®æ”¹ï¼šå‚³é€å®Œæ•´çš„ cart ç‰©ä»¶çµ¦ GAS
        await fetch(GAS_URL, { 
            method: 'POST', 
            body: JSON.stringify({ 
                userId: profile.userId, 
                userName: profile.displayName, 
                cartJson: JSON.stringify(cart), // ğŸ‘ˆ é€™è£¡æŠŠè³¼ç‰©è»Šç‰©ä»¶è½‰æˆå­—ä¸²å‚³éå»
                totalPrice: finalTotal 
            }) 
        });

            // ç™¼é€ LINE è¨Šæ¯
            if (liff.isInClient()) {
                await liff.sendMessages([{
                    type: 'text',
                    text: `ğŸ“¦ è¨‚å–®å·²é€å‡ºæˆåŠŸï¼\n\nã€è¨‚å–®æ˜ç´°ã€‘\n${details.replace(/, /g, '\n')}\n\nğŸ’° ç¸½é‡‘é¡(å«é‹)ï¼š$${total}\n\n----------------\nğŸ¦ åŒ¯æ¬¾è³‡è¨Š\néŠ€è¡Œï¼š(396) è¡—å£æ”¯ä»˜\nå¸³è™Ÿï¼š903241863\n\nğŸ’¡ æº«é¦¨æç¤ºï¼š\nåŒ¯æ¬¾å¾Œè«‹å›å‚³æˆªåœ–æˆ–å‘ŠçŸ¥åŒ¯æ¬¾å¸³è™Ÿï¼Œä»¥ä¾¿æ ¸å°å‡ºè²¨å–”ï¼`
                }]);
            }
            
            localStorage.removeItem('shopCart');
            alert("è¨‚å–®å·²é€å‡ºï¼Œè«‹æŸ¥çœ‹èŠå¤©å®¤å…§çš„åŒ¯æ¬¾è³‡è¨Šï¼");
            liff.closeWindow();
        } catch (e) {
            alert("é€å‡ºå¤±æ•—ï¼š" + e);
        }
    }

    function jumpPage(p) { page = parseInt(p); render(); window.scrollTo(0,0); }
    init();
</script>
</body>
</html>













