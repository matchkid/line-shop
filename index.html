<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-color: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }

        /* 1. é ‚éƒ¨å°è¦½ */
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: white; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .search-area { padding: 10px 15px; }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; box-sizing: border-box; background: #f9f9f9; }
        .nav-tabs { display: flex; justify-content: space-around; padding-bottom: 0; border-bottom: 1px solid #eee; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: white; font-size: 14px; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
        .nav-btn.active { color: var(--line-green); border-bottom: 3px solid var(--line-green); font-weight: bold; }

        .main-content { padding-top: 100px; padding-bottom: 100px; }

        /* 2. é¦–é  & å•†å“ */
        .section-title { padding: 15px 15px 5px; font-weight: bold; font-size: 16px; display: block; }
        .feat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; }
        .feat-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .feat-item img { width: 100%; height: 120px; object-fit: cover; }
        .feat-info { padding: 8px; text-align: center; font-size: 13px; }
        .info-box { background: white; margin: 15px; padding: 15px; border-radius: 8px; border-left: 5px solid var(--line-green); font-size: 14px; line-height: 1.6; color: #555; }
        
        .cat-scroller { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; background: white; white-space: nowrap; border-bottom: 1px solid #f0f0f0; }
        .cat-pill { padding: 6px 14px; border-radius: 20px; background: #f0f0f0; font-size: 13px; color: #555; cursor: pointer; }
        .cat-pill.active { background: var(--line-green); color: white; }

        .p-card { display: flex; background: white; padding: 10px; border-radius: 8px; margin: 10px 15px; align-items: center; }
        .p-img { width: 70px; height: 70px; border-radius: 6px; object-fit: cover; margin-right: 12px; }
        .p-details { flex: 1; }
        .p-link { text-decoration: none; color: #333; font-weight: bold; border-bottom: 1px dashed #999; }
        .p-price { color: #e44d26; font-weight: bold; display: block; margin-top: 4px; }
        .qty-box { display: flex; align-items: center; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty-val { margin: 0 8px; font-weight: bold; min-width: 20px; text-align: center; }

        /* 3. æ­·å²ç´€éŒ„æ¨£å¼ */
        .history-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .hist-item-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 6px; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        .status-badge[data-status="å·²å‡ºè²¨"] { background: #d4edda; color: #155724; }
        .status-badge[data-status="è™•ç†ä¸­"] { background: #fff3cd; color: #856404; }

        /* 4. è³¼ç‰©è»Š & æˆåŠŸå½ˆçª— */
        .cart-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #333; color: white; padding: 12px 20px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-height: 80vh; border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .btn-submit { width: 100%; background: var(--line-green); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 15px; }
        .btn-close { width: 100%; background: #f0f0f0; color: #666; border: none; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 10px; }

        .success-box { text-align: center; padding: 20px 0; }
        .bank-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; border: 1px dashed #ccc; }
        .copy-btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-left: 10px; cursor: pointer; }

        .pager { text-align: center; padding: 15px; }
    </style>
</head>
<body>

    <div class="fixed-header">
        <div class="search-area">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹å•†å“..." oninput="doSearch()">
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-home" onclick="switchTab('home')">é¦–é </button>
            <button class="nav-btn" id="tab-cat" onclick="switchTab('cat')">å•†å“ç›®éŒ„</button>
            <button class="nav-btn" id="tab-hist" onclick="switchTab('hist')">æ­·å²ç´€éŒ„</button>
        </div>
    </div>

    <div class="main-content">
        <div id="view-home">
            <span class="section-title">ğŸ”¥ åº—é•·ç²¾é¸</span>
            <div class="feat-grid">
                <div class="feat-item" onclick="quickAdd('ç²¾é¸å•†å“A', 490)">
                    <img src="https://via.placeholder.com/200x150?text=Hot+Sale">
                    <div class="feat-info">ç²¾é¸å•†å“A<br><b style="color:red">$490</b></div>
                </div>
                <div class="feat-item" onclick="quickAdd('ç²¾é¸å•†å“B', 320)">
                    <img src="https://via.placeholder.com/200x150?text=New+Item">
                    <div class="feat-info">ç²¾é¸å•†å“B<br><b style="color:red">$320</b></div>
                </div>
            </div>
            <div class="info-box">
                <b>ğŸ“¢ è³¼ç‰©å…¬å‘Š</b><br>
                1. å…¨é¤¨æ»¿ $8000 å…é‹ã€‚<br>
                2. åŒ¯æ¬¾å¾Œè«‹å‘ŠçŸ¥å¸³è™Ÿå¾Œäº”ç¢¼ã€‚
            </div>
        </div>

        <div id="view-cat" class="hidden">
            <div class="cat-scroller" id="catBar"></div>
            <div id="catList" style="margin-top:10px;"></div>
            <div class="pager">
                <button onclick="changePage(-1)">ä¸Šä¸€é </button>
                <span id="pageInfo">1/1</span>
                <button onclick="changePage(1)">ä¸‹ä¸€é </button>
            </div>
        </div>

        <div id="view-hist" class="hidden">
            <div id="histList" style="padding-top:10px;"></div>
        </div>
    </div>

    <div id="cartBar" class="cart-bar hidden" onclick="openCartModal()">
        <div>ğŸ›’ å·²é¸ <span id="barCount">0</span> ä»¶</div>
        <div style="font-weight:bold;">æŸ¥çœ‹æ˜ç´° ></div>
    </div>

    <div id="cartModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ“‹ è³¼ç‰©è»Šç¢ºèª</h3>
            <div id="modalItems"></div>
            <div id="modalShippingInfo" style="text-align:right; margin-top:10px; font-size:13px; color:#666;"></div>
            <div style="text-align:right; margin-top:5px; font-weight:bold; font-size:18px; color:#e44d26;">
                ç¸½è¨ˆ: $<span id="modalTotal">0</span>
            </div>
            <button class="btn-submit" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
            <button class="btn-close" onclick="closeCartModal()">ç¹¼çºŒè³¼ç‰©</button>
        </div>
    </div>

    <div id="successModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="success-box">
                <div style="font-size:50px;">ğŸ‰</div>
                <h2 style="color:var(--line-green);">è¨‚å–®å·²é€å‡ºï¼</h2>
                <p>åŒ¯æ¬¾å®Œæˆå¾Œè«‹æˆªåœ–æˆ–å‘ŠçŸ¥å¸³è™Ÿå¾Œ5ç¢¼ï¼Œä»¥åˆ©æ ¸å°ï¼Œè¬è¬ã€‚</p>
                <div class="bank-info">
                    <b>è¡—å£æ”¯ä»˜ (396)</b><br>
                    å¸³è™Ÿï¼š<span id="bankAccNumber">903241863</span> 
                    <button class="copy-btn" onclick="copyBank()">è¤‡è£½</button>
                </div>
                <button class="btn-submit" onclick="finishOrder()">å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxA0orWqV0evidtMpVApbr9CO34UC5RcAPSkM98VpVSAhUmK-KXhl1TLHDZG1CRRRc5ZQ/exec"; 
        const LIFF_ID = "2009084382-z4lJ5Lc6"; 
        const BANK_ACC = "903241863"; 

        let allProducts = [], displayList = [], cart = {};
        let currentPage = 1, pageSize = 10;
        let currentUser = null;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            currentUser = { id: profile.userId, name: profile.displayName };
            
            // æŠ“å–å•†å“è³‡æ–™
            const res = await fetch(GAS_URL);
            allProducts = await res.json();
            displayList = allProducts;
            
            initCategories();
            checkRegister(); // éœé»˜æª¢æŸ¥è¨»å†Š
        }

        async function checkRegister() {
            fetch(`${GAS_URL}?action=checkUser&userId=${currentUser.id}`);
        }

        // --- åˆ†é¡èˆ‡æœå°‹ ---
        function initCategories() {
            const rawCats = allProducts.map(p => p.category);
            let uniqueCats = new Set(["å…¨éƒ¨"]);
            rawCats.forEach(cStr => {
                if(cStr) cStr.split('/').forEach(c => uniqueCats.add(c.trim()));
            });
            const bar = document.getElementById('catBar');
            bar.innerHTML = Array.from(uniqueCats).map(c => 
                `<div class="cat-pill" onclick="filterCat(this, '${c}')">${c}</div>`
            ).join('');
            if(bar.firstElementChild) bar.firstElementChild.classList.add('active');
        }

        function filterCat(btn, cat) {
            document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            displayList = (cat === "å…¨éƒ¨") ? allProducts : allProducts.filter(p => p.category.includes(cat));
            currentPage = 1; renderProducts();
        }

        function doSearch() {
            const key = document.getElementById('searchInput').value.toLowerCase();
            if(key) {
                switchTab('cat');
                displayList = allProducts.filter(p => p.name.toLowerCase().includes(key));
            } else { displayList = allProducts; }
            currentPage = 1; renderProducts();
        }

        // --- è¦–åœ–åˆ‡æ› ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-cat').classList.add('hidden');
            document.getElementById('view-hist').classList.add('hidden');

            if (tab === 'home') document.getElementById('view-home').classList.remove('hidden');
            if (tab === 'cat') { document.getElementById('view-cat').classList.remove('hidden'); renderProducts(); }
            if (tab === 'hist') { document.getElementById('view-hist').classList.remove('hidden'); loadHistory(); }
            window.scrollTo(0,0);
        }

        // --- å•†å“æ¸²æŸ“ ---
        function renderProducts() {
            const list = document.getElementById('catList');
            const start = (currentPage - 1) * pageSize;
            const chunk = displayList.slice(start, start + pageSize);

            list.innerHTML = chunk.map(p => {
                const qty = cart[p.name] ? cart[p.name].qty : 0;
                const nameHtml = p.link ? `<a href="${p.link}" target="_blank" class="p-link">${p.name} ğŸ”—</a>` : `<b>${p.name}</b>`;
                const noteHtml = p.note ? `<div style="font-size:12px; color:#888; font-style:italic; margin-top:2px;">/ ${p.note}</div>` : '';
                
                return `
                <div class="p-card">
                    <img class="p-img" src="${p.img || 'https://via.placeholder.com/70'}">
                    <div class="p-details">
                        ${nameHtml} 
                        ${noteHtml}  
                        <span class="p-price">$${p.price}</span>
                    </div>
                    <div class="qty-box">
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, -1)">-</div>
                        <span class="qty-val">${qty}</span>
                        <div class="qty-btn" onclick="updateCart('${p.name}', ${p.price}, 1)">+</div>
                    </div>
                </div>`;
            }).join('');
            
            const totalPage = Math.ceil(displayList.length / pageSize) || 1;
            document.getElementById('pageInfo').innerText = `${currentPage} / ${totalPage}`;
        }

        function changePage(d) {
            const max = Math.ceil(displayList.length / pageSize) || 1;
            currentPage = Math.max(1, Math.min(max, currentPage + d));
            renderProducts();
            window.scrollTo(0,0);
        }

        // --- æ ¸å¿ƒè³¼ç‰©è»Šé‚è¼¯ ---
        function updateCart(name, price, d) {
            if(!cart[name]) cart[name] = { price, qty: 0 };
            cart[name].qty += d;
            if(cart[name].qty <= 0) delete cart[name];
            updateCartBar();
            // å¦‚æœç›®å‰æ­£åœ¨ç›®éŒ„é ï¼ŒåŒæ­¥æ›´æ–°åˆ—è¡¨ä¸Šçš„æ•¸å­—
            if(!document.getElementById('view-cat').classList.contains('hidden')) renderProducts();
        }

        function quickAdd(name, price) {
            updateCart(name, price, 1);
            alert(`å·²å°‡ ${name} åŠ å…¥è³¼ç‰©è»Š`);
        }

        function updateCartBar() {
            let count = 0;
            for(let k in cart) count += cart[k].qty;
            const bar = document.getElementById('cartBar');
            if(count > 0) {
                bar.classList.remove('hidden');
                document.getElementById('barCount').innerText = count;
            } else { bar.classList.add('hidden'); }
        }

        // --- è³¼ç‰©è»Šå½ˆçª— (å«åŠ æ¸›æŒ‰éˆ•) ---
        function openCartModal() {
            const box = document.getElementById('modalItems');
            box.innerHTML = "";
            let subtotal = 0;
            let hasItem = false;

            for (let n in cart) {
                hasItem = true;
                const itemTotal = cart[n].price * cart[n].qty;
                subtotal += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.style = "display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee;";
                itemDiv.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${n}</div>
                        <div style="font-size:12px; color:#e44d26;">$${cart[n].price} / å°è¨ˆ: $${itemTotal}</div>
                    </div>
                    <div class="qty-box">
                        <div class="qty-btn" onclick="updateCartInModal('${n}', ${cart[n].price}, -1)">-</div>
                        <span class="qty-val">${cart[n].qty}</span>
                        <div class="qty-btn" onclick="updateCartInModal('${n}', ${cart[n].price}, 1)">+</div>
                    </div>
                `;
                box.appendChild(itemDiv);
            }

            if(!hasItem) {
                box.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">è³¼ç‰©è»Šç©ºç©ºçš„å–”ï¼</p>';
                subtotal = 0;
            }

            const shipping = (subtotal >= 8000 || subtotal === 0) ? 0 : 100;
            document.getElementById('modalShippingInfo').innerText = `å•†å“å°è¨ˆ: $${subtotal} + é‹è²»: $${shipping}`;
            document.getElementById('modalTotal').innerText = subtotal + shipping;
            document.getElementById('cartModal').classList.remove('hidden');
        }

        // å°ˆç‚ºè³¼ç‰©è»Šå½ˆçª—è¨­è¨ˆçš„æ›´æ–°å‡½å¼
        function updateCartInModal(name, price, d) {
            updateCart(name, price, d); // å…ˆæ›´æ–°æ•¸æ“š
            openCartModal(); // é‡æ–°æ¸²æŸ“è¦–çª—å…§å®¹ (ä¸æœƒé—œé–‰è¦–çª—)
        }

        function closeCartModal() { document.getElementById('cartModal').classList.add('hidden'); }

        async function submitOrder() {
            const count = Object.keys(cart).length;
            if(count === 0) { alert("è³¼ç‰©è»Šå…§æ²’æœ‰å•†å“å–”ï¼"); return; }
            if(!confirm("ç¢ºå®šé€å‡ºè¨‚å–®ï¼Ÿ")) return;
            
            const btn = document.querySelector('.btn-submit');
            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;
            
            const payload = { userId: currentUser.id, userName: currentUser.name, cartJson: JSON.stringify(cart) };
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const r = await res.json();
                if(r.status === 'success') {
                    closeCartModal();
                    document.getElementById('successModal').classList.remove('hidden');
                    // ç™¼é€è¨‚å–®æ‘˜è¦çµ¦ä½¿ç”¨è€…
                    await liff.sendMessages([{ type: 'text', text: r.msg }]);
                    cart = {};
                    updateCartBar();
                } else {
                    alert("ä¸‹å–®å¤±æ•—ï¼š" + r.message);
                }
            } catch(e) {
                alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
            btn.innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
            btn.disabled = false;
        }

        function copyBank() {
            navigator.clipboard.writeText(BANK_ACC).then(() => { alert("å·²è¤‡è£½åŒ¯æ¬¾å¸³è™Ÿï¼"); });
        }

        function finishOrder() {
            document.getElementById('successModal').classList.add('hidden');
            switchTab('hist'); // ä¸‹å–®å®Œå°å‘æ­·å²ç´€éŒ„
        }

        // --- æ­·å²ç´€éŒ„æ¸²æŸ“ ---
        async function loadHistory() {
            const list = document.getElementById('histList');
            list.innerHTML = '<div style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</div>';
            
            const res = await fetch(`${GAS_URL}?action=getHistory&userId=${currentUser.id}`);
            const data = await res.json();
            
            if(!data || data.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ç›®å‰æ²’æœ‰è¨‚å–®ç´€éŒ„</div>';
                return;
            }

            list.innerHTML = data.map(o => `
                <div class="history-card">
                    <div class="history-header">
                        <span>${o.date}</span>
                        <span>å–®è™Ÿ: ${o.id.slice(-6)}</span>
                    </div>
                    <div>
                        ${o.items.map(i => `
                            <div class="hist-item-row">
                                <span>${i.name} x${i.qty}</span>
                                <span class="status-badge" data-status="${i.itemStatus}">${i.itemStatus}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align:right; font-weight:bold; color:#e44d26; margin-top:8px; border-top:1px solid #eee; padding-top:5px;">
                        é‹è²»: $${o.shipping} / ç¸½è¨ˆ: $${o.total}
                    </div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>
</html>

