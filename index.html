<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --line-green: #06C755;
            --bg-gray: #f4f4f4;
            --text-dark: #333;
            --capsule-bg: #eeeeee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
        }

        /* --- é ‚éƒ¨å›ºå®šå€ --- */
        .sticky-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-main {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            justify-content: space-between;
        }

        .header-title { font-weight: bold; font-size: 18px; }

        /* --- æœå°‹æ¡† --- */
        .search-container {
            padding: 0 15px 10px 15px;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
            box-sizing: border-box;
            font-size: 14px;
        }

        /* --- å›ºå®šä½ç½®çš„è† å›Šå°èˆªæŒ‰éˆ• (åŸæœ¬å½ˆè·³æ”¹å›ºå®š) --- */
        .capsule-nav {
            display: flex;
            gap: 10px;
            padding: 5px 15px 12px 15px;
            overflow-x: auto;
            white-space: nowrap;
            background: white;
        }
        /* éš±è—æ»¾å‹•æ¢ */
        .capsule-nav::-webkit-scrollbar { display: none; }

        .capsule-btn {
            background: var(--capsule-bg);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        .capsule-btn.active {
            background: var(--line-green);
            color: white;
        }

        /* --- å…§å®¹å€é–“è·ä¿®æ­£ --- */
        .main-content {
            padding-top: 130px; /* é¿é–‹é ‚éƒ¨å›ºå®šå€ */
            padding-bottom: 100px; /* é¿é–‹åº•éƒ¨è³¼ç‰©è»Šéˆ• */
        }

        .container { padding: 0 10px; }

        /* --- é¦–é å€å¡Š --- */
        .announcement-box {
            background: white;
            margin: 10px;
            padding: 15px;
            border-radius: 12px;
            border-left: 5px solid var(--line-green);
        }

        /* --- æ¨è–¦å•†å“å€å¡Š (æ‰‹å‹•åœ–ç‰‡é€£çµå€) --- */
        .recommend-section {
            margin: 15px 10px;
        }
        .section-title { font-weight: bold; margin-bottom: 10px; display: block; }
        .recommend-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        /* æ‰‹å‹•å¡«å¯«åœ–ç‰‡å•†å“æ¨£å¼ */
        .manual-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            text-decoration: none;
            color: inherit;
        }
        .manual-item img { width: 100%; display: block; height: 150px; object-fit: cover; }
        .manual-item .p-info { padding: 8px; font-size: 13px; }

        /* --- å•†å“æ¸…å–®æ¨£å¼ --- */
        .product-card {
            background: white;
            border-radius: 10px;
            display: flex;
            padding: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .product-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .product-detail { flex: 1; margin-left: 12px; }
        .product-price { color: #e44d26; font-weight: bold; }

        .qty-controls { display: flex; align-items: center; }
        .btn-qty {
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd;
            background: white; font-size: 18px; display: flex; align-items: center; justify-content: center;
        }
        .qty-num { margin: 0 10px; font-weight: bold; }

        /* --- åˆ†é å™¨ (ç›´æ¥æ’åœ¨å•†å“ä¸‹æ–¹) --- */
        .pager-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 0;
            margin-top: -5px; /* ç·Šè²¼å•†å“å€å¡Š */
            background: transparent;
        }
        .pager-select { padding: 5px; border-radius: 5px; margin-left: 10px; }

        /* --- åº•éƒ¨è³¼ç‰©è»Šæ¢ --- */
        .footer-cart {
            position: fixed;
            bottom: 20px; left: 15px; right: 15px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
        }
        .btn-checkout {
            background: var(--line-green);
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* éš±è—é‚è¼¯ */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px;">è¼‰å…¥ä¸­...</div>

    <div id="app" class="hidden">
        <div class="sticky-header">
            <div class="header-main">
                <div class="header-title" id="pageTitle">å–œå¹¼ å¾®å•†åŸ</div>
                <div style="font-size: 12px; color: #888;" onclick="showHistory()">ğŸ“‹ ç´€éŒ„</div>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å•†å“åç¨±..." oninput="handleSearch()">
            </div>

            <div class="capsule-nav">
                <button class="capsule-btn active" id="btn-home" onclick="navTo('home')">ğŸ  é¦–é ç²¾é¸</button>
                <button class="capsule-btn" id="btn-catalog" onclick="navTo('catalog')">ğŸ“‚ æ‰€æœ‰ç›®éŒ„</button>
                <button class="capsule-btn" id="btn-history" onclick="navTo('history')">ğŸ“‹ æˆ‘çš„è¨‚å–®</button>
                <button class="capsule-btn" onclick="liff.closeWindow()">âŒ é—œé–‰</button>
            </div>
        </div>

        <div class="main-content">
            <div id="view-home">
                <div class="announcement-box">
                    <b style="color: var(--line-green);">ğŸ“¢ é–€å¸‚å…¬å‘Š</b><br>
                    <span style="font-size: 13px; color: #666;">å…¨é¤¨æ»¿ $1000 å…é‹ï¼åŒ¯æ¬¾å¾Œè«‹æˆªåœ–å›å‚³ã€‚</span>
                </div>

                <div class="recommend-section">
                    <span class="section-title">âœ¨ åº—é•·æ¨è–¦å•†å“</span>
                    <div class="recommend-grid">
                        <div class="manual-item" onclick="quickAdd('æ¨è–¦å•†å“A', 490)">
                            <img src="https://via.placeholder.com/200x150?text=Product+A">
                            <div class="p-info"><b>ç²¾é¸è­·é«®ç´ </b><br><span style="color:#e44d26;">$490</span></div>
                        </div>
                        <div class="manual-item" onclick="quickAdd('æ¨è–¦å•†å“B', 320)">
                            <img src="https://via.placeholder.com/200x150?text=Product+B">
                            <div class="p-info"><b>ä¿æ¿•é¢è†œçµ„</b><br><span style="color:#e44d26;">$320</span></div>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 10px; font-weight: bold;">ğŸ”¥ ç†±éŠ·å•†å“æ¸…å–®</div>
                <div id="home-list" class="container"></div>
            </div>

            <div id="view-catalog" class="hidden">
                <div id="category-bar" style="padding: 10px; overflow-x: auto; display: flex; gap: 8px;"></div>
                <div id="catalog-list" class="container"></div>
                
                <div class="pager-container" id="pager">
                    <span id="pageInfo" style="font-size: 14px;">ç¬¬ 1 é  / å…± 1 é </span>
                    <select id="pageSelect" class="pager-select" onchange="changePage(this.value)"></select>
                </div>
            </div>

            <div id="view-history" class="hidden">
                <div id="history-list" class="container"></div>
            </div>
        </div>

        <div id="cartBar" class="footer-cart" onclick="showCartDetails()">
            <div>å·²é¸ <span id="cartCount">0</span> ä»¶ï¼Œå…± $<span id="cartTotal">0</span></div>
            <button class="btn-checkout">ç¢ºèªä¸‹å–®</button>
        </div>
    </div>

    <script>
        const GAS_URL = "ä½ çš„GASä½ˆç½²ç¶²å€"; // âš ï¸ è«‹æ›´æ›
        let allProducts = [];
        let filteredProducts = [];
        let cart = {};
        let currentPage = 1;
        const pageSize = 10;
        let currentView = 'home';

        // --- åˆå§‹åŒ– ---
        async function init() {
            try {
                await liff.init({ liffId: "ä½ çš„LIFF_ID" }); // âš ï¸ è«‹æ›´æ›
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                // å‘ GAS æŠ“å–è³‡æ–™
                const resp = await fetch(GAS_URL);
                allProducts = await resp.json();
                filteredProducts = allProducts;
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                renderHome();
                renderCategoryBar();
            } catch (e) {
                alert("è¼‰å…¥å¤±æ•—: " + e);
            }
        }

        // --- å°è¦½åˆ‡æ› ---
        function navTo(view) {
            currentView = view;
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-catalog').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');
            
            document.querySelectorAll('.capsule-btn').forEach(b => b.classList.remove('active'));
            
            if(view === 'home') {
                document.getElementById('view-home').classList.remove('hidden');
                document.getElementById('btn-home').classList.add('active');
                document.getElementById('pageTitle').innerText = "å–œå¹¼ å¾®å•†åŸ";
            } else if (view === 'catalog') {
                document.getElementById('view-catalog').classList.remove('hidden');
                document.getElementById('btn-catalog').classList.add('active');
                document.getElementById('pageTitle').innerText = "å•†å“ç›®éŒ„";
                renderCatalog();
            } else if (view === 'history') {
                document.getElementById('view-history').classList.remove('hidden');
                document.getElementById('btn-history').classList.add('active');
                document.getElementById('pageTitle').innerText = "æ­·å²è¨‚å–®";
                loadHistory();
            }
            window.scrollTo(0,0);
        }

        // --- æœå°‹åŠŸèƒ½ ---
        function handleSearch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(keyword));
            currentPage = 1;
            
            if(currentView === 'home') renderHome();
            else renderCatalog();
        }

        // --- æ¸²æŸ“é¦–é  (æ¨è–¦/ç²¾é¸) ---
        function renderHome() {
            const homeList = document.getElementById('home-list');
            // é€™è£¡é¡¯ç¤ºå‰ 5 ç­†ç•¶ä½œç†±éŠ·
            const list = filteredProducts.slice(0, 5);
            homeList.innerHTML = list.map(p => productTemplate(p)).join('');
        }

        // --- æ¸²æŸ“åˆ†é¡èˆ‡ç›®éŒ„ ---
        function renderCategoryBar() {
            const categories = [...new Set(allProducts.map(p => p.category))];
            const bar = document.getElementById('category-bar');
            bar.innerHTML = `<button onclick="filterCat('')" style="padding:5px 10px; border-radius:15px; border:1px solid #ddd; background:white;">å…¨éƒ¨</button>` + 
                categories.map(c => `<button onclick="filterCat('${c}')" style="padding:5px 10px; border-radius:15px; border:1px solid #ddd; background:white;">${c}</button>`).join('');
        }

        function filterCat(cat) {
            filteredProducts = cat ? allProducts.filter(p => p.category === cat) : allProducts;
            currentPage = 1;
            renderCatalog();
        }

        function renderCatalog() {
            const start = (currentPage - 1) * pageSize;
            const list = filteredProducts.slice(start, start + pageSize);
            document.getElementById('catalog-list').innerHTML = list.map(p => productTemplate(p)).join('');
            updatePager();
        }

        // --- åˆ†é é‚è¼¯ (ç·Šè²¼ä¸‹æ–¹) ---
        function updatePager() {
            const totalPages = Math.ceil(filteredProducts.length / pageSize) || 1;
            document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
            
            const select = document.getElementById('pageSelect');
            select.innerHTML = "";
            for(let i=1; i<=totalPages; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = `è·³è‡³ç¬¬ ${i} é `;
                if(i === currentPage) opt.selected = true;
                select.appendChild(opt);
            }
        }

        function changePage(p) {
            currentPage = parseInt(p);
            renderCatalog();
            window.scrollTo(0,0);
        }

        // --- å•†å“æ¨£å¼æ¨¡æ¿ ---
        function productTemplate(p) {
            const q = cart[p.name] ? cart[p.name].qty : 0;
            return `
                <div class="product-card">
                    <img class="product-img" src="${p.img || 'https://via.placeholder.com/80'}">
                    <div class="product-detail">
                        <b>${p.name}</b><br>
                        <span class="product-price">$${p.price}</span>
                    </div>
                    <div class="qty-controls">
                        <button class="btn-qty" onclick="updateCart('${p.name}', ${p.price}, -1)">-</button>
                        <span class="qty-num">${q}</span>
                        <button class="btn-qty" onclick="updateCart('${p.name}', ${p.price}, 1)">+</button>
                    </div>
                </div>
            `;
        }

        // --- è³¼ç‰©è»Šé‚è¼¯ ---
        function updateCart(name, price, delta) {
            if(!cart[name]) cart[name] = { price: price, qty: 0 };
            cart[name].qty += delta;
            if(cart[name].qty <= 0) delete cart[name];
            
            updateCartUI();
            // é‡æ–°æ¸²æŸ“ç•¶å‰æ¸…å–®ä»¥æ›´æ–°æ•¸å­—
            if(currentView === 'home') renderHome();
            else renderCatalog();
        }

        function quickAdd(name, price) {
            updateCart(name, price, 1);
            alert("å·²åŠ å…¥è³¼ç‰©è»Š: " + name);
        }

        function updateCartUI() {
            let total = 0, count = 0;
            for(let k in cart) {
                total += cart[k].price * cart[k].qty;
                count += cart[k].qty;
            }
            const bar = document.getElementById('cartBar');
            if(count > 0) {
                bar.style.display = 'flex';
                document.getElementById('cartCount').innerText = count;
                document.getElementById('cartTotal').innerText = total;
            } else {
                bar.style.display = 'none';
            }
        }

        // --- çµå¸³èˆ‡æ­·å²ç´€éŒ„ ---
        async function showCartDetails() {
            if(confirm("ç¢ºå®šè¦é€å‡ºè¨‚å–®å—ï¼Ÿ")) {
                const profile = await liff.getProfile();
                const body = {
                    action: 'submitOrder',
                    userId: profile.userId,
                    userName: profile.displayName,
                    cartJson: JSON.stringify(cart)
                };
                
                const resp = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(body) });
                const result = await resp.json();
                if(result.status === 'success') {
                    alert("è¨‚å–®å·²é€å‡ºï¼å–®è™Ÿ: " + result.orderId);
                    cart = {};
                    updateCartUI();
                    navTo('history');
                }
            }
        }

        async function loadHistory() {
            const profile = await liff.getProfile();
            const resp = await fetch(`${GAS_URL}?action=getHistory&userId=${profile.userId}`);
            const data = await resp.json();
            const list = document.getElementById('history-list');
            if(data.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>å°šç„¡è¨‚å–®ç´€éŒ„</p>";
                return;
            }
            list.innerHTML = data.map(o => `
                <div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">
                        <b style="font-size:12px;">${o.orderId}</b>
                        <span style="color:var(--line-green); font-size:12px;">${o.status}</span>
                    </div>
                    <div style="font-size:14px; color:#555;">${o.details}</div>
                    <div style="text-align:right; margin-top:5px; font-weight:bold;">ç¸½è¨ˆ: $${o.total}</div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>
</html>
