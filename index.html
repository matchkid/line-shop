<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å‹å•†åŸ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* 1. å­—é«”ç¸®å°èˆ‡æ•´é«”é¢¨æ ¼èª¿å„ª */
        :root { --line-green: #06C755; --bg-gray: #f4f4f4; --text-main: #333; --text-sub: #888; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-gray); margin: 0; color: var(--text-main); font-size: 14px; }
        
        /* å°è¦½åˆ— */
        .header { background: #fff; padding: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; font-size: 15px; }

        /* å•†å“å¡ç‰‡ï¼šå­—é«”æ›´å°æ›´ç²¾ç·» */
        .container { padding: 10px; padding-bottom: 120px; }
        .product-card { background: #fff; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .product-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 12px; }
        .info b { font-size: 13px; display: block; margin-bottom: 4px; }
        .info span { color: #e44d26; font-weight: bold; font-size: 12px; }

        /* æ•¸é‡æŒ‰éˆ• */
        .controls { margin-left: auto; display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px; }
        .btn-qty { width: 24px; height: 24px; border: none; background: #fff; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .qty { min-width: 25px; text-align: center; font-size: 12px; font-weight: bold; }

        /* æ¨¡ä»¿ Linote çš„å›ºå®šåº•æ¬„ */
        .linote-footer { 
            position: fixed; bottom: 15px; left: 15px; right: 15px; 
            background: #333; color: #fff; border-radius: 30px; 
            padding: 10px 20px; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000; transition: transform 0.3s;
        }
        .cart-info { font-size: 12px; }
        .cart-info b { font-size: 16px; color: var(--line-green); }
        .btn-cart { background: var(--line-green); color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; font-size: 13px; }

        /* è³¼ç‰©è»Šå½ˆå‡ºè¦–çª— (Modal) */
        #cartModal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: none; z-index: 2000; 
            justify-content: center; align-items: flex-end;
        }
        .modal-content { 
            background: #fff; width: 100%; border-radius: 20px 20px 0 0; 
            padding: 20px; max-height: 70%; overflow-y: auto; 
        }
        .modal-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .modal-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>

<div class="header" id="title">ğŸ›’ é¸è³¼å•†å“</div>

<div class="container" id="productList">
    </div>

<div style="text-align:center; padding-bottom: 100px;">
    <button onclick="changePage(-1)" style="font-size:12px; padding:5px 10px;">ä¸Šä¸€é </button>
    <span id="pageInfo" style="font-size:12px; margin: 0 10px;">ç¬¬ 1 é </span>
    <button onclick="changePage(1)" style="font-size:12px; padding:5px 10px;">ä¸‹ä¸€é </button>
</div>

<div class="linote-footer" id="footerBar">
    <div class="cart-info">å·²é¸ <span id="cartCount">0</span> ä»¶ï¼Œå…± <b>$<span id="cartTotal">0</span></b></div>
    <button class="btn-cart" onclick="openCart()">æŸ¥çœ‹æ¸…å–®</button>
</div>

<div id="cartModal" onclick="closeCart(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-title">ç¢ºèªè¨‚å–®æ˜ç´°</div>
        <div id="cartDetails"></div>
        <div style="margin-top:20px; text-align: center;">
            <button class="btn-cart" style="width:100%; padding:12px;" onclick="finalSubmit()">ç¢ºèªçµå¸³é€å‡º</button>
            <p onclick="closeCart()" style="color:#888; font-size:12px; margin-top:15px;">è¿”å›ä¿®æ”¹</p>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = '2009084382-z4lJ5Lc6'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyBs1ypFFNnnKfBekSdRn6b5WJffkEp3n1FV7IljQ8VNXaL6wnnC-ujwVTPXHKfkwsE_w/exec';

    let products = [];
    let cart = {}; // æ ¼å¼: { "å“å": { qty: 1, price: 100 } }
    let page = 1;
    const size = 6;

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        fetchData();
    }

    async function fetchData() {
        const res = await fetch(GAS_URL);
        products = await res.json();
        render();
    }

    function render() {
        const start = (page - 1) * size;
        const display = products.slice(start, start + size);
        const list = document.getElementById('productList');
        list.innerHTML = display.map(p => `
            <div class="product-card">
                <img class="product-img" src="${p.img || ''}">
                <div class="info">
                    <b>${p.name}</b>
                    <span>$${p.price}</span>
                </div>
                <div class="controls">
                    <button class="btn-qty" onclick="add('${p.name}', ${p.price}, -1)">-</button>
                    <div class="qty" id="q-${p.name}">${cart[p.name]?.qty || 0}</div>
                    <button class="btn-qty" onclick="add('${p.name}', ${p.price}, 1)">+</button>
                </div>
            </div>
        `).join('');
        document.getElementById('pageInfo').innerText = `ç¬¬ ${page} é `;
    }

    function add(name, price, delta) {
        if (!cart[name]) cart[name] = { qty: 0, price: price };
        cart[name].qty += delta;
        if (cart[name].qty <= 0) delete cart[name];
        
        updateFooter();
        render(); // åˆ·æ–°ç•¶å‰é é¢æ•¸å­—
    }

    function updateFooter() {
        let total = 0, count = 0;
        for (let key in cart) {
            total += cart[key].qty * cart[key].price;
            count += cart[key].qty;
        }
        document.getElementById('cartTotal').innerText = total;
        document.getElementById('cartCount').innerText = count;
        // å¦‚æœè³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œéš±è—åº•æ¬„
        document.getElementById('footerBar').style.transform = count > 0 ? "translateY(0)" : "translateY(100px)";
    }

    function openCart() {
        const details = document.getElementById('cartDetails');
        let html = '';
        for (let key in cart) {
            html += `<div class="modal-item"><span>${key} x ${cart[key].qty}</span><span>$${cart[key].qty * cart[key].price}</span></div>`;
        }
        details.innerHTML = html + `<div class="modal-item" style="font-weight:bold; border:none; font-size:15px;"><span>ç¸½è¨ˆ</span><span>$${document.getElementById('cartTotal').innerText}</span></div>`;
        document.getElementById('cartModal').style.display = 'flex';
    }

    function closeCart() { document.getElementById('cartModal').style.display = 'none'; }

    async function finalSubmit() {
        const profile = await liff.getProfile();
        const items = Object.entries(cart).map(([name, obj]) => `${name}x${obj.qty}`).join(', ');
        const total = document.getElementById('cartTotal').innerText;

        await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                userId: profile.userId,
                userName: profile.displayName,
                details: items,
                totalPrice: total
            })
        });

        await liff.sendMessages([{ type: 'text', text: `âœ… è¨‚å–®å·²ç¢ºèªï¼\né …ç›®ï¼š${items}\né‡‘é¡ï¼š$${total}` }]);
        liff.closeWindow();
    }

    function changePage(d) {
        if (page + d < 1 || (page + d - 1) * size >= products.length) return;
        page += d; render();
    }

    init();
</script>
</body>
</html>



