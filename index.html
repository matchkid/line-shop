<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg: #f4f7f6; }
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background: var(--bg); margin: 0; font-size: 14px; color: #333; }
        
        /* è¨»å†Šé®ç½© */
        #regModal { position: fixed; inset: 0; background: white; z-index: 9999; display: none; padding: 40px 25px; }
        .reg-input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }

        /* é ‚éƒ¨å°èˆª */
        .header { background: #fff; padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { color: var(--line-green); font-size: 14px; cursor: pointer; visibility: hidden; }

        /* åˆ†é¡æŒ‰éˆ• */
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .cat-card { background: white; padding: 25px 10px; border-radius: 15px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-weight: bold; font-size: 12px; }

        /* å•†å“æ¸…å–® */
        .container { padding: 10px; padding-bottom: 120px; }
        .product-card { background: #fff; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .product-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 12px; }
        .info b { font-size: 12px; display: inline-block; }
        .product-note { font-style: italic; color: #999; font-size: 11px; margin-left: 5px; }
        
        /* åˆ†é æ§åˆ¶é … */
        .pager { text-align: center; padding: 20px; font-size: 12px; color: #888; border-top: 1px solid #eee; }
        .pager select { margin-left: 8px; padding: 4px; border-radius: 5px; border: 1px solid #ccc; background: #fff; }

        /* è³¼ç‰©è»Šåº•æ¬„ (Linote é¢¨æ ¼) */
        .linote-footer { position: fixed; bottom: 15px; left: 15px; right: 15px; background: #333; color: #fff; border-radius: 30px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; transition: 0.3s; transform: translateY(120px); }
        
        /* å½ˆçª— */
        #cartModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 2000; align-items: flex-end; }
        .modal-content { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; max-height: 80%; overflow-y: auto; box-sizing: border-box; }
        .btn-green { background: var(--line-green); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; width: 100%; font-size: 15px; margin-top: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="regModal">
    <h2 style="margin-top:0">ğŸ‘‹ æ‚¨å¥½ï¼</h2>
    <p style="color:#666">é¦–æ¬¡ä½¿ç”¨è«‹å…ˆç™»è¨˜è¯çµ¡è³‡è¨Šï¼š</p>
    <input type="text" id="regName" class="reg-input" placeholder="æ”¶ä»¶äººå§“å">
    <input type="tel" id="regPhone" class="reg-input" placeholder="è¯çµ¡é›»è©±">
    <button class="btn-green" onclick="registerUser()">é–‹å§‹è³¼ç‰©</button>
</div>

<div id="mainApp" class="hidden">
    <div class="header">
        <div id="backBtn" class="back-btn" onclick="showCategories()">â® è¿”å›</div>
        <div id="title">å•†å“åˆ†é¡</div>
        <div style="width:40px"></div>
    </div>

    <div id="categoryView" class="cat-grid"></div>

    <div id="shopView" class="hidden">
        <div class="container" id="productList"></div>
        <div class="pager">
            <span id="pageText">ç¬¬ 1 é  / å…± 1 é </span>
            <select id="pageSelect" onchange="jumpPage(this.value)"></select>
        </div>
    </div>
</div>

<div class="linote-footer" id="footerBar">
    <div style="font-size:12px;">å·²é¸ <span id="cartCount">0</span> ä»¶ï¼Œå…± <b>$<span id="cartTotal">0</span></b></div>
    <button onclick="openCart()" style="background:var(--line-green); color:#fff; border:none; padding:6px 16px; border-radius:15px; font-weight:bold; font-size:13px;">ç¢ºèªè³¼ç‰©è»Š</button>
</div>

<div id="cartModal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="text-align:center; margin-top:0;">è¨‚å–®æ˜ç´°ç¢ºèª</h3>
        <div id="cartDetails"></div>
        <button class="btn-green" onclick="finalSubmit()">é€å‡ºè¨‚å–®</button>
    </div>
</div>

<script>
    const LIFF_ID = '2009084382-z4lJ5Lc6'; // âš ï¸ æ”¹é€™è£¡
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwtA2UqAFK34pBSEIEZJdXpwpdvUmwq9xUGQSrvzYzWoO6xxmDVApIocgvy31mCbnYHtQ/exec'; // âš ï¸ æ”¹é€™è£¡

    let allData = [], filteredProducts = [], page = 1, size = 6;
    let cart = JSON.parse(localStorage.getItem('shopCart')) || {};

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        
        // 1. æª¢æŸ¥è¨»å†Š
        const res = await fetch(`${GAS_URL}?action=checkUser&userId=${profile.userId}`);
        const user = await res.json();
        if (!user.registered) {
            document.getElementById('regModal').style.display = 'block';
        } else {
            loadShopData();
        }
        updateFooter();
    }

    async function registerUser() {
        const name = document.getElementById('regName').value;
        const phone = document.getElementById('regPhone').value;
        if(!name || !phone) return alert("è«‹å®Œæ•´å¡«å¯«");
        const profile = await liff.getProfile();
        await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action:'register', userId:profile.userId, userName:name, phone:phone }) });
        document.getElementById('regModal').style.display = 'none';
        loadShopData();
    }

    async function loadShopData() {
        document.getElementById('mainApp').classList.remove('hidden');
        const res = await fetch(GAS_URL);
        allData = await res.json();
        showCategories();
    }

    function showCategories() {
        document.getElementById('categoryView').classList.remove('hidden');
        document.getElementById('shopView').classList.add('hidden');
        document.getElementById('backBtn').style.visibility = 'hidden';
        document.getElementById('title').innerText = "å•†å“åˆ†é¡";

        let cats = [];
        allData.forEach(p => { if(p.category) cats = cats.concat(p.category.split('/')); });
        const uniqueCats = [...new Set(cats.filter(c => c))];

        document.getElementById('categoryView').innerHTML = uniqueCats.map(c => `
            <div class="cat-card" onclick="showProducts('${c}')">${c}</div>
        `).join('');
    }

    function showProducts(cat) {
        document.getElementById('categoryView').classList.add('hidden');
        document.getElementById('shopView').classList.remove('hidden');
        document.getElementById('backBtn').style.visibility = 'visible';
        document.getElementById('title').innerText = cat;
        
        filteredProducts = allData.filter(p => p.category && p.category.split('/').includes(cat));
        page = 1;
        render();
    }

    function render() {
        const totalPages = Math.ceil(filteredProducts.length / size) || 1;
        const start = (page - 1) * size;
        const displayItems = filteredProducts.slice(start, start + size);
        
        document.getElementById('productList').innerHTML = displayItems.map(p => `
            <div class="product-card">
                <img class="product-img" src="${p.img || ''}">
                <div class="info">
                    <b>${p.name}</b> <i class="product-note">${p.note || ''}</i><br>
                    <span style="color:#e44d26; font-weight:bold;">$${p.price}</span>
                </div>
                <div style="margin-left:auto; display:flex; align-items:center; background:#f8f8f8; border-radius:20px; padding:2px;">
                    <button onclick="add('${p.name}',${p.price},-1)" style="width:26px; height:26px; border-radius:50%; border:none; background:#fff;">-</button>
                    <span style="width:25px; text-align:center; font-weight:bold; font-size:12px;" id="q-${p.name}">${cart[p.name]?.qty || 0}</span>
                    <button onclick="add('${p.name}',${p.price},1)" style="width:26px; height:26px; border-radius:50%; border:none; background:var(--line-green); color:#fff;">+</button>
                </div>
            </div>
        `).join('');

        document.getElementById('pageText').innerText = `ç¬¬ ${page} é  / å…± ${totalPages} é `;
        let opt = '';
        for(let i=1; i<=totalPages; i++) opt += `<option value="${i}" ${i===page?'selected':''}>è·³è‡³ç¬¬ ${i} é </option>`;
        document.getElementById('pageSelect').innerHTML = opt;
    }

    function add(name, price, d) {
        if(!cart[name]) cart[name] = { qty: 0, price: price };
        cart[name].qty += d;
        if(cart[name].qty <= 0) delete cart[name];
        localStorage.setItem('shopCart', JSON.stringify(cart));
        if(document.getElementById(`q-${name}`)) document.getElementById(`q-${name}`).innerText = cart[name]?.qty || 0;
        updateFooter();
    }

    function updateFooter() {
        let total = 0, count = 0;
        for(let k in cart) { total += cart[k].qty * cart[k].price; count += cart[k].qty; }
        document.getElementById('cartTotal').innerText = total;
        document.getElementById('cartCount').innerText = count;
        document.getElementById('footerBar').style.transform = count > 0 ? "translateY(0)" : "translateY(120px)";
    }

    function openCart() {
        let h = '';
        for(let k in cart) h += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; font-size:13px;"><span>${k} x ${cart[k].qty}</span><span>$${cart[k].qty*cart[k].price}</span></div>`;
        document.getElementById('cartDetails').innerHTML = h + `<div style="text-align:right; font-weight:bold; padding:10px 0;">ç¸½é‡‘é¡ï¼š$${document.getElementById('cartTotal').innerText}</div>`;
        document.getElementById('cartModal').style.display = 'flex';
    }

    async function finalSubmit() {
        const profile = await liff.getProfile();
        const details = Object.entries(cart).map(([n,o]) => `${n}x${o.qty}`).join(', ');
        await fetch(GAS_URL, { method:'POST', body:JSON.stringify({ userId:profile.userId, userName:profile.displayName, details:details, totalPrice:document.getElementById('cartTotal').innerText }) });
        localStorage.removeItem('shopCart');
        liff.sendMessages([{ type: 'text', text: `âœ… è¨‚å–®å·²é€å‡ºï¼\né …ç›®ï¼š${details}\nç¸½é‡‘é¡ï¼š$${document.getElementById('cartTotal').innerText}` }]);
        liff.closeWindow();
    }

    function jumpPage(p) { page = parseInt(p); render(); window.scrollTo(0,0); }
    init();
</script>
</body>
</html>


