<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–œå¹¼ å¾®å•†åŸ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg: #f4f4f4; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* 1. é ‚éƒ¨æœå°‹å›ºå®š */
        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: white; z-index: 1000; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ddd; box-sizing: border-box; outline: none; }

        /* 2. è† å›Šå°è¦½ (æœå°‹ä¸‹æ–¹) */
        .nav-scroll { display: flex; gap: 10px; padding: 10px; overflow-x: auto; background: white; margin-top: 55px; }
        .nav-btn { background: #eee; padding: 6px 15px; border-radius: 20px; font-size: 13px; white-space: nowrap; border: none; }
        .nav-btn.active { background: var(--line-green); color: white; }

        .main-container { padding-bottom: 120px; }

        /* 3. ä¸­é–“æ¨è–¦å€å¡Š */
        .featured-section { padding: 15px; }
        .featured-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .feat-card { background: white; border-radius: 8px; overflow: hidden; }
        .feat-card img { width: 100%; height: 120px; object-fit: cover; }
        .feat-info { padding: 8px; text-align: center; }

        /* 4. åº•éƒ¨æ–‡å­—è¨Šæ¯å€ */
        .text-msg-box { background: #fff; margin: 15px; padding: 20px; border-radius: 10px; line-height: 1.6; color: #555; border-left: 4px solid var(--line-green); }

        /* 5. å•†å“æ¸…å–®æ¨£å¼ (ç›®éŒ„é ä½¿ç”¨) */
        .product-item { display: flex; align-items: center; background: white; padding: 10px; margin-bottom: 1px; }
        .p-img { width: 70px; height: 70px; border-radius: 5px; object-fit: cover; }
        .p-info { flex: 1; margin-left: 10px; }
        .qty-group { display: flex; align-items: center; }
        .q-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 50%; font-size: 20px; }
        .q-num { margin: 0 10px; font-weight: bold; }

        /* åˆ†é å™¨ï¼šç·Šè²¼æ¸…å–®ä¸‹æ–¹ */
        .pager { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; }

        /* åº•éƒ¨è³¼ç‰©è»Š */
        .cart-footer { position: fixed; bottom: 25px; left: 15px; right: 15px; background: #333; color: white; padding: 15px 20px; border-radius: 35px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; display: none; }
        .btn-order { background: var(--line-green); color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹å•†å“..." oninput="handleSearch()">
    </div>

    <div class="nav-scroll">
        <button class="nav-btn active" id="btn-home" onclick="goView('home')">ğŸ  ç²¾é¸é¦–é </button>
        <button class="nav-btn" id="btn-cat" onclick="goView('cat')">ğŸ“‚ å…¨éƒ¨ç›®éŒ„</button>
        <button class="nav-btn" onclick="goView('history')">ğŸ“‹ è¨‚å–®ç´€éŒ„</button>
    </div>

    <div class="main-container">
        <div id="view-home">
            <div class="featured-section">
                <b style="display:block; margin-bottom:10px;">ğŸ”¥ ç²¾é¸æ¨è–¦</b>
                <div class="featured-grid">
                    <div class="feat-card" onclick="updateCart('æ¨è–¦å•†å“A', 490, 1)">
                        <img src="https://via.placeholder.com/200x150?text=Product+A">
                        <div class="feat-info">ç²¾é¸å•†å“A<br><b style="color:red;">$490</b></div>
                    </div>
                    <div class="feat-card" onclick="updateCart('æ¨è–¦å•†å“B', 320, 1)">
                        <img src="https://via.placeholder.com/200x150?text=Product+B">
                        <div class="feat-info">ç²¾é¸å•†å“B<br><b style="color:red;">$320</b></div>
                    </div>
                    <div class="feat-card" onclick="updateCart('æ¨è–¦å•†å“C', 320, 2)">
                        <img src="https://via.placeholder.com/200x150?text=Product+B">
                        <div class="feat-info">ç²¾é¸å•†å“B<br><b style="color:red;">$320</b></div>
                    </div>
                </div>
            </div>

            <div class="text-msg-box">
                <b>ğŸ’¡ è³¼ç‰©é ˆçŸ¥</b><br>
                1. å…¨é¤¨æ¶ˆè²»æ»¿ $8000 å…é‹ï¼Œæœªæ»¿æ”¶ $100ã€‚<br>
                2. ä¸‹å–®å¾Œè«‹æ–¼ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ã€‚<br>
                3. åŒ¯æ¬¾å¾Œè«‹æä¾›å¾Œäº”ç¢¼ä»¥åˆ©æ ¸å¸³ã€‚<br>
                <br>
                ç¥æ‚¨è³¼ç‰©æ„‰å¿«ï¼
            </div>
        </div>

        <div id="view-cat" class="hidden">
            <div id="productList"></div>
            <div class="pager" id="pagerBox">
                <button onclick="changePage(-1)">ä¸Šä¸€é </button>
                <span id="pageTxt">ç¬¬ 1 é  / å…± 1 é </span>
                <button onclick="changePage(1)">ä¸‹ä¸€é </button>
            </div>
        </div>

        <div id="view-history" class="hidden" id="historyList"></div>
    </div>

    <div id="cartBar" class="cart-footer" onclick="submitOrder()">
        <div>å·²é¸ <span id="cartCount">0</span> ä»¶ï¼Œå…± $<span id="cartTotal">0</span></div>
        <button class="btn-order">ç¢ºèªè¨‚å–®é€å‡º</button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw2_A0EH2r5bWHliSPX-G822jMI9DcVbEaQaugeRFkqHmecOsGK1tqRt8vsEnYonzNnIg/exec"; //æ‚¨çš„GASä½ˆç½²ç¶²å€
        let allItems = [], filtered = [], cart = {}, page = 1, size = 10;

        async function init() {
            await liff.init({ liffId: "2009084382-z4lJ5Lc6" }); //LIFF ID
            const resp = await fetch(GAS_URL);
            allItems = await resp.json();
            filtered = allItems;
            render();
        }

        function goView(v) {
            document.getElementById('view-home').classList.toggle('hidden', v !== 'home');
            document.getElementById('view-cat').classList.toggle('hidden', v !== 'cat');
            document.getElementById('view-history').classList.toggle('hidden', v !== 'history');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(v === 'home') document.getElementById('btn-home').classList.add('active');
            if(v === 'cat') { document.getElementById('btn-cat').classList.add('active'); render(); }
            if(v === 'history') loadHistory();
            window.scrollTo(0,0);
        }

        function handleSearch() {
            const key = document.getElementById('searchInput').value.toLowerCase();
            filtered = allItems.filter(i => i.name.toLowerCase().includes(key));
            page = 1;
            goView('cat'); // æœå°‹æ™‚è‡ªå‹•åˆ‡æ›åˆ°ç›®éŒ„è¦–åœ–
            render();
        }

        function render() {
            const list = document.getElementById('productList');
            const start = (page - 1) * size;
            const data = filtered.slice(start, start + size);
            
            list.innerHTML = data.map(i => {
                const q = cart[i.name] ? cart[i.name].qty : 0;
                return `
                <div class="product-item">
                    <img class="p-img" src="${i.img || ''}">
                    <div class="p-info">
                        <b>${i.name}</b><br><span style="color:red;">$${i.price}</span>
                    </div>
                    <div class="qty-group">
                        <button class="q-btn" onclick="updateCart('${i.name}', ${i.price}, -1)">-</button>
                        <span class="q-num">${q}</span>
                        <button class="q-btn" onclick="updateCart('${i.name}', ${i.price}, 1)">+</button>
                    </div>
                </div>`;
            }).join('');

            const totalPages = Math.ceil(filtered.length / size) || 1;
            document.getElementById('pageTxt').innerText = `ç¬¬ ${page} é  / å…± ${totalPages} é `;
        }

        function changePage(d) {
            const max = Math.ceil(filtered.length / size) || 1;
            page = Math.max(1, Math.min(max, page + d));
            render();
            window.scrollTo(0,0);
        }

        function updateCart(name, price, delta) {
            if(!cart[name]) cart[name] = { price: price, qty: 0 };
            cart[name].qty += delta;
            if(cart[name].qty <= 0) delete cart[name];
            
            let count = 0, total = 0;
            for(let k in cart) { count += cart[k].qty; total += cart[k].qty * cart[k].price; }
            
            document.getElementById('cartBar').style.display = count > 0 ? 'flex' : 'none';
            document.getElementById('cartCount').innerText = count;
            document.getElementById('cartTotal').innerText = total;
            render(); // åˆ·æ–°æ•¸å­—
        }

        async function submitOrder() {
            if(!confirm("ç¢ºå®šè¦é€å‡ºè¨‚å–®ï¼Ÿ")) return;
            const profile = await liff.getProfile();
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    userId: profile.userId,
                    userName: profile.displayName,
                    cartJson: JSON.stringify(cart)
                })
            });
            const result = await res.json();
            if(result.status === 'success') {
                // é€é LIFF åœ¨å°è©±æ¡†ç™¼é€æ˜ç´°
                await liff.sendMessages([{ type: 'text', text: result.msg }]);
                alert("ä¸‹å–®æˆåŠŸï¼");
                cart = {};
                updateCart('', 0, 0);
                liff.closeWindow();
            }
        }

        init();
    </script>
</body>
</html>
